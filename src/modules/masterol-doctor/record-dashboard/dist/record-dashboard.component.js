"use strict";
var __decorate = (this && this.__decorate) || function (decorators, target, key, desc) {
    var c = arguments.length, r = c < 3 ? target : desc === null ? desc = Object.getOwnPropertyDescriptor(target, key) : desc, d;
    if (typeof Reflect === "object" && typeof Reflect.decorate === "function") r = Reflect.decorate(decorators, target, key, desc);
    else for (var i = decorators.length - 1; i >= 0; i--) if (d = decorators[i]) r = (c < 3 ? d(r) : c > 3 ? d(target, key, r) : d(target, key)) || r;
    return c > 3 && r && Object.defineProperty(target, key, r), r;
};
var __awaiter = (this && this.__awaiter) || function (thisArg, _arguments, P, generator) {
    function adopt(value) { return value instanceof P ? value : new P(function (resolve) { resolve(value); }); }
    return new (P || (P = Promise))(function (resolve, reject) {
        function fulfilled(value) { try { step(generator.next(value)); } catch (e) { reject(e); } }
        function rejected(value) { try { step(generator["throw"](value)); } catch (e) { reject(e); } }
        function step(result) { result.done ? resolve(result.value) : adopt(result.value).then(fulfilled, rejected); }
        step((generator = generator.apply(thisArg, _arguments || [])).next());
    });
};
var __generator = (this && this.__generator) || function (thisArg, body) {
    var _ = { label: 0, sent: function() { if (t[0] & 1) throw t[1]; return t[1]; }, trys: [], ops: [] }, f, y, t, g;
    return g = { next: verb(0), "throw": verb(1), "return": verb(2) }, typeof Symbol === "function" && (g[Symbol.iterator] = function() { return this; }), g;
    function verb(n) { return function (v) { return step([n, v]); }; }
    function step(op) {
        if (f) throw new TypeError("Generator is already executing.");
        while (_) try {
            if (f = 1, y && (t = op[0] & 2 ? y["return"] : op[0] ? y["throw"] || ((t = y["return"]) && t.call(y), 0) : y.next) && !(t = t.call(y, op[1])).done) return t;
            if (y = 0, t) op = [op[0] & 2, t.value];
            switch (op[0]) {
                case 0: case 1: t = op; break;
                case 4: _.label++; return { value: op[1], done: false };
                case 5: _.label++; y = op[1]; op = [0]; continue;
                case 7: op = _.ops.pop(); _.trys.pop(); continue;
                default:
                    if (!(t = _.trys, t = t.length > 0 && t[t.length - 1]) && (op[0] === 6 || op[0] === 2)) { _ = 0; continue; }
                    if (op[0] === 3 && (!t || (op[1] > t[0] && op[1] < t[3]))) { _.label = op[1]; break; }
                    if (op[0] === 6 && _.label < t[1]) { _.label = t[1]; t = op; break; }
                    if (t && _.label < t[2]) { _.label = t[2]; _.ops.push(op); break; }
                    if (t[2]) _.ops.pop();
                    _.trys.pop(); continue;
            }
            op = body.call(thisArg, _);
        } catch (e) { op = [6, e]; y = 0; } finally { f = t = 0; }
        if (op[0] & 5) throw op[1]; return { value: op[0] ? op[1] : void 0, done: true };
    }
};
exports.__esModule = true;
exports.RecordDashboardComponent = void 0;
var core_1 = require("@angular/core");
var Parse = require("parse");
var RecordDashboardComponent = /** @class */ (function () {
    function RecordDashboardComponent(http, router) {
        this.http = http;
        this.router = router;
        this.listOfColumn = [
            {
                title: '学生',
                compare: null,
                priority: false
            },
            {
                title: '学校',
                compare: null,
                priority: false
            },
            {
                title: '专业',
                compare: null,
                priority: false
            },
            {
                title: '班级',
                compare: null,
                priority: false
            },
            {
                title: '课程名称',
                compare: null,
                priority: false
            },
            {
                title: '学习状态',
                compare: null,
                priority: false
            },
            {
                title: '学习进度',
                compare: null,
                priority: false
            },
            {
                title: '学习时长',
                compare: function (a, b) { return a.totalTime - b.totalTime; },
                priority: false
            },
            {
                title: '操作',
                compare: null,
                priority: false
            }
        ];
        this.listOfData = [];
        this.isShcool = true;
        this.lessons = []; // 对应专业的所有课程
        this.showSchool = true;
    }
    RecordDashboardComponent.prototype.ngOnInit = function () {
        return __awaiter(this, void 0, void 0, function () {
            var Department;
            var _this = this;
            return __generator(this, function (_a) {
                switch (_a.label) {
                    case 0:
                        if (!localStorage.getItem('department')) return [3 /*break*/, 2];
                        this.department = localStorage.getItem('department');
                        Department = new Parse.Query("Department");
                        return [4 /*yield*/, Department.get(this.department).then(function (res) {
                                "";
                                _this.showSchool = false;
                                if (res && res.get('school')) {
                                    console.log(res.get('school')[0].id);
                                    _this.isShcool = false;
                                    _this.changeSchool(res.get('school')[0].id);
                                }
                                else {
                                    _this.changeSchool(res.id);
                                }
                            })];
                    case 1:
                        _a.sent();
                        _a.label = 2;
                    case 2: return [4 /*yield*/, this.getCompany(this.department).then(function (res) {
                            console.log(_this.company);
                            _this.searchAll();
                            _this.getSchool();
                        })];
                    case 3:
                        _a.sent();
                        return [2 /*return*/];
                }
            });
        });
    };
    RecordDashboardComponent.prototype.getCompany = function (did) {
        return __awaiter(this, void 0, void 0, function () {
            var Department, department;
            return __generator(this, function (_a) {
                switch (_a.label) {
                    case 0:
                        if (!did) return [3 /*break*/, 2];
                        Department = new Parse.Query('Department');
                        return [4 /*yield*/, Department.get(did)];
                    case 1:
                        department = _a.sent();
                        if (department && department.id) {
                            this.company = department.get('company').id;
                        }
                        return [3 /*break*/, 3];
                    case 2:
                        this.company = localStorage.getItem('company');
                        _a.label = 3;
                    case 3: return [2 /*return*/];
                }
            });
        });
    };
    RecordDashboardComponent.prototype.getSchool = function () {
        var _this = this;
        var Department = new Parse.Query('Department');
        if (this.company == 'pPZbxElQQo') {
            Department.equalTo('category', 'erVPCmBAgt');
        }
        Department.equalTo('company', this.company);
        Department.find().then(function (res) {
            console.log(res);
            _this.schools = res;
        });
    };
    RecordDashboardComponent.prototype.searchAll = function (csql) {
        var _this = this;
        // let 
        var sql;
        if (localStorage.getItem('department')) {
            var department = localStorage.getItem('department');
            if (!this.isShcool) {
                // 代理中心
                sql = csql ? csql : "select\n    \"PInfo\".\"uid\" as \"uid\",\n    \"PInfo\".\"mid\" as \"mid\",\n    \"PInfo\".\"lid\" as \"lid\",\n    \"PInfo\".\"user\" as \"user\",\n    \"PInfo\".\"school\" as \"school\",\n    \"PInfo\".\"major\" as \"major\",\n    \"PInfo\".\"class\" as \"class\",\n    \"PInfo\".\"title\" as \"title\",\n    \"LRInfo\".\"totalTime\" as \"totalTime\",\n    \"LRInfo\".\"downCount\" as \"downCount\",\n    \"LRInfo\".\"total\" as \"total\"\n  from \n    (select \n      \"PR\".\"pid\" as \"uid\",\n      \"PR\".\"mid\" as \"mid\",\n      \"PR\".\"name\" as \"user\",\n      \"PR\".\"school\" as \"school\",\n      \"PR\".\"major\" as \"major\",\n      \"PR\".\"class\" as \"class\",\n      \"M\".\"title\" as \"title\",\n      \"M\".\"objectId\" as \"lid\"\n    from\n      (select\n        \"profile\".\"objectId\" as \"pid\",\n        \"profile\".\"name\" as \"name\",\n        \"department\".\"name\" as \"school\",\n        \"schoolMajor\".\"name\" as \"major\",\n        \"schoolMajor\".\"objectId\" as \"mid\",\n        \"schoolMajor\".\"plan\" as \"plan\",\n        \"schoolClass\".\"name\" as \"class\"\n      from \"Profile\" as \"profile\"\n      left join \"Department\" as \"department\" on \"department\".\"objectId\" = \"profile\".\"department\" \n      left join \"SchoolMajor\" as \"schoolMajor\" on \"schoolMajor\".\"objectId\" = \"profile\".\"SchoolMajor\"\n      left join \"SchoolClass\" as \"schoolClass\" on \"schoolClass\".\"objectId\" = \"profile\".\"schoolClass\"\n      where \"profile\".\"company\" = 'pPZbxElQQo' and \"profile\".\"center\" = '" + department + "') as \"PR\"\n  left join\n  (select \n    max(\"majors\".\"majorid\") as \"majorid\",\n    max(\"majors\".\"planid\") as \"planid\",\n    max(\"majors\".\"name\") as \"name\",\n    max(\"lessons\".\"objectId\") as \"objectId\",\n    max(\"lessons\".\"title\") as \"title\",\n    max(\"lessons\".\"teacher\") as \"teacher\"\n  from\n  (select \n    \"schoolMajor\".\"objectId\" as \"majorid\",\n     \"schoolMajor\".\"plan\" as \"planid\",\n    \"schoolMajor\".\"name\" as \"name\"\n  from \"SchoolMajor\" as \"schoolMajor\" where \"schoolMajor\".\"company\" = 'pPZbxElQQo') as \"majors\"\n  left join (\n    select \n      \"lessonObjectId\".\"planid\" as \"planid\",\n      \"lessonObjectId\".\"objectId\" as \"objectId\" ,\n        \"lesson\".\"title\" as \"title\" ,\n      \"teacher\".\"name\" as \"teacher\" \n    from\n       (select \n           \"lessons\".\"lesson\"::json->>'objectId' as \"objectId\",\n        \"lessons\".\"planid\" as \"planid\"\n        from (\n        select \n             jsonb_array_elements(\"plan\".\"lessons\") as \"lesson\",\n          \"plan\".\"objectId\" as \"planid\"\n             from \"SchoolPlan\" as \"plan\"\n       left  join \"SchoolMajor\" as \"major\" on \"major\".\"plan\" = \"plan\".\"objectId\" ) as \"lessons\") as \"lessonObjectId\"\n    left join \"Lesson\" as \"lesson\" on \"lessonObjectId\".\"objectId\" =  \"lesson\".\"objectId\"\n    left join \"LessonTeacher\" as \"teacher\" on  \"lesson\".\"schoolTeacher\" = \"teacher\".\"objectId\"\n  ) as \"lessons\" on \"lessons\".\"planid\" = \"majors\".\"planid\"\n  group by \"majorid\", \"objectId\"\n  order by \"majorid\") as \"M\" on  \"PR\".\"mid\" = \"M\".\"majorid\") as \"PInfo\"\n  left join (\n    SELECT \n    \"R\".\"user\" as \"user\",\n    \"R\".\"uid\" as \"uid\",\n    \"R\".\"lid\" as \"lid\",\n    \"R\".\"totalTime\" as \"totalTime\",\n    \"R\".\"downCount\" as \"downCount\",\n    \"totalCount\".\"total\" as \"total\"\n  from \n  (SELECT\n          max(\"profile\".\"name\")  as \"user\",\n          max(\"profile\".\"objectId\")  as \"uid\",\n          max(\"lesson\".\"objectId\") as \"lid\",\n          sum(\"record\".\"time\") as \"totalTime\",\n          sum(case when \"record\".\"status\" = 2  then 1 else 0 end) as \"downCount\"\n       from \"LessonRecord\" as \"record\"\n        left join \"Profile\" as \"profile\" on \"profile\".\"objectId\" = \"record\".\"user\"\n        left join \"Department\" as \"Department\" on \"Department\".\"objectId\" = \"record\".\"department\"\n        left join \"SchoolMajor\" as \"schoolMajor\" on \"schoolMajor\".\"objectId\" = \"profile\".\"SchoolMajor\"\n        left join \"SchoolClass\" as \"schoolClass\" on \"schoolClass\".\"objectId\" = \"profile\".\"schoolClass\"\n        left join \"Lesson\" as \"lesson\" on \"lesson\".\"objectId\" = \"record\".\"lesson\"\n      where \"record\".\"company\" = 'pPZbxElQQo'\n        group by \"record\".\"user\", \"record\".\"lesson\") as \"R\"\n  left join \n  (select\n     count(1) as \"total\",\n     max(\"LessonArticle\".\"objectId\") as \"laid\",\n    max(\"LessonArticle\".\"lesson\") as \"lid\"\n   from \"LessonArticle\"\n   left join \"Lesson\" as \"lesson\" on \"lesson\".\"objectId\" = \"LessonArticle\".\"lesson\"\n   where \"LessonArticle\".\"parent\" is not null and \"LessonArticle\".\"company\" = 'pPZbxElQQo'\n   group by \"LessonArticle\".\"lesson\") as \"totalCount\" on \"totalCount\".\"lid\" = \"R\".\"lid\"\n        ) as \"LRInfo\" on \"LRInfo\".\"uid\" = \"PInfo\".\"uid\" and \"LRInfo\".\"lid\" = \"PInfo\".\"lid\"";
            }
            else {
                //  学校
                sql = csql ? csql : "select\n    \"PInfo\".\"uid\" as \"uid\",\n    \"PInfo\".\"mid\" as \"mid\",\n    \"PInfo\".\"lid\" as \"lid\",\n    \"PInfo\".\"user\" as \"user\",\n    \"PInfo\".\"school\" as \"school\",\n    \"PInfo\".\"major\" as \"major\",\n    \"PInfo\".\"class\" as \"class\",\n    \"PInfo\".\"title\" as \"title\",\n    \"LRInfo\".\"totalTime\" as \"totalTime\",\n    \"LRInfo\".\"downCount\" as \"downCount\",\n    \"LRInfo\".\"total\" as \"total\"\n  from \n    (select \n      \"PR\".\"pid\" as \"uid\",\n      \"PR\".\"mid\" as \"mid\",\n      \"PR\".\"name\" as \"user\",\n      \"PR\".\"school\" as \"school\",\n      \"PR\".\"major\" as \"major\",\n      \"PR\".\"class\" as \"class\",\n      \"M\".\"title\" as \"title\",\n      \"M\".\"objectId\" as \"lid\"\n    from\n      (select\n        \"profile\".\"objectId\" as \"pid\",\n        \"profile\".\"name\" as \"name\",\n        \"department\".\"name\" as \"school\",\n        \"schoolMajor\".\"name\" as \"major\",\n        \"schoolMajor\".\"objectId\" as \"mid\",\n        \"schoolMajor\".\"plan\" as \"plan\",\n        \"schoolClass\".\"name\" as \"class\"\n      from \"Profile\" as \"profile\"\n      left join \"Department\" as \"department\" on \"department\".\"objectId\" = \"profile\".\"department\" \n      left join \"SchoolMajor\" as \"schoolMajor\" on \"schoolMajor\".\"objectId\" = \"profile\".\"SchoolMajor\"\n      left join \"SchoolClass\" as \"schoolClass\" on \"schoolClass\".\"objectId\" = \"profile\".\"schoolClass\"\n      where \"profile\".\"company\" = 'pPZbxElQQo' and \"profile\".\"department\" = '" + department + "') as \"PR\"\n  left join\n  (select \n    max(\"majors\".\"majorid\") as \"majorid\",\n    max(\"majors\".\"planid\") as \"planid\",\n    max(\"majors\".\"name\") as \"name\",\n    max(\"lessons\".\"objectId\") as \"objectId\",\n    max(\"lessons\".\"title\") as \"title\",\n    max(\"lessons\".\"teacher\") as \"teacher\"\n  from\n  (select \n    \"schoolMajor\".\"objectId\" as \"majorid\",\n     \"schoolMajor\".\"plan\" as \"planid\",\n    \"schoolMajor\".\"name\" as \"name\"\n  from \"SchoolMajor\" as \"schoolMajor\" where \"schoolMajor\".\"company\" = 'pPZbxElQQo') as \"majors\"\n  left join (\n    select \n      \"lessonObjectId\".\"planid\" as \"planid\",\n      \"lessonObjectId\".\"objectId\" as \"objectId\" ,\n        \"lesson\".\"title\" as \"title\" ,\n      \"teacher\".\"name\" as \"teacher\" \n    from\n       (select \n           \"lessons\".\"lesson\"::json->>'objectId' as \"objectId\",\n        \"lessons\".\"planid\" as \"planid\"\n        from (\n        select \n             jsonb_array_elements(\"plan\".\"lessons\") as \"lesson\",\n          \"plan\".\"objectId\" as \"planid\"\n             from \"SchoolPlan\" as \"plan\"\n       left  join \"SchoolMajor\" as \"major\" on \"major\".\"plan\" = \"plan\".\"objectId\" ) as \"lessons\") as \"lessonObjectId\"\n    left join \"Lesson\" as \"lesson\" on \"lessonObjectId\".\"objectId\" =  \"lesson\".\"objectId\"\n    left join \"LessonTeacher\" as \"teacher\" on  \"lesson\".\"schoolTeacher\" = \"teacher\".\"objectId\"\n  ) as \"lessons\" on \"lessons\".\"planid\" = \"majors\".\"planid\"\n  group by \"majorid\", \"objectId\"\n  order by \"majorid\") as \"M\" on  \"PR\".\"mid\" = \"M\".\"majorid\") as \"PInfo\"\n  left join (\n    SELECT \n    \"R\".\"user\" as \"user\",\n    \"R\".\"uid\" as \"uid\",\n    \"R\".\"lid\" as \"lid\",\n    \"R\".\"totalTime\" as \"totalTime\",\n    \"R\".\"downCount\" as \"downCount\",\n    \"totalCount\".\"total\" as \"total\"\n  from \n  (SELECT\n          max(\"profile\".\"name\")  as \"user\",\n          max(\"profile\".\"objectId\")  as \"uid\",\n          max(\"lesson\".\"objectId\") as \"lid\",\n          sum(\"record\".\"time\") as \"totalTime\",\n          sum(case when \"record\".\"status\" = 2  then 1 else 0 end) as \"downCount\"\n       from \"LessonRecord\" as \"record\"\n        left join \"Profile\" as \"profile\" on \"profile\".\"objectId\" = \"record\".\"user\"\n        left join \"Department\" as \"Department\" on \"Department\".\"objectId\" = \"record\".\"department\"\n        left join \"SchoolMajor\" as \"schoolMajor\" on \"schoolMajor\".\"objectId\" = \"profile\".\"SchoolMajor\"\n        left join \"SchoolClass\" as \"schoolClass\" on \"schoolClass\".\"objectId\" = \"profile\".\"schoolClass\"\n        left join \"Lesson\" as \"lesson\" on \"lesson\".\"objectId\" = \"record\".\"lesson\"\n      where \"record\".\"company\" = 'pPZbxElQQo'\n        group by \"record\".\"user\", \"record\".\"lesson\") as \"R\"\n  left join \n  (select\n     count(1) as \"total\",\n     max(\"LessonArticle\".\"objectId\") as \"laid\",\n    max(\"LessonArticle\".\"lesson\") as \"lid\"\n   from \"LessonArticle\"\n   left join \"Lesson\" as \"lesson\" on \"lesson\".\"objectId\" = \"LessonArticle\".\"lesson\"\n   where \"LessonArticle\".\"parent\" is not null and \"LessonArticle\".\"company\" = 'pPZbxElQQo'\n   group by \"LessonArticle\".\"lesson\") as \"totalCount\" on \"totalCount\".\"lid\" = \"R\".\"lid\"\n        ) as \"LRInfo\" on \"LRInfo\".\"uid\" = \"PInfo\".\"uid\" and \"LRInfo\".\"lid\" = \"PInfo\".\"lid\"";
            }
        }
        else {
            // 总部
            sql = csql ? csql : "select\n    \"PInfo\".\"uid\" as \"uid\",\n    \"PInfo\".\"mid\" as \"mid\",\n    \"PInfo\".\"lid\" as \"lid\",\n    \"PInfo\".\"user\" as \"user\",\n    \"PInfo\".\"school\" as \"school\",\n    \"PInfo\".\"major\" as \"major\",\n    \"PInfo\".\"class\" as \"class\",\n    \"PInfo\".\"title\" as \"title\",\n    \"LRInfo\".\"totalTime\" as \"totalTime\",\n    \"LRInfo\".\"downCount\" as \"downCount\",\n    \"LRInfo\".\"total\" as \"total\"\n  from \n    (select \n      \"PR\".\"pid\" as \"uid\",\n      \"PR\".\"mid\" as \"mid\",\n      \"PR\".\"name\" as \"user\",\n      \"PR\".\"school\" as \"school\",\n      \"PR\".\"major\" as \"major\",\n      \"PR\".\"class\" as \"class\",\n      \"M\".\"title\" as \"title\",\n      \"M\".\"objectId\" as \"lid\"\n    from\n      (select\n        \"profile\".\"objectId\" as \"pid\",\n        \"profile\".\"name\" as \"name\",\n        \"department\".\"name\" as \"school\",\n        \"schoolMajor\".\"name\" as \"major\",\n        \"schoolMajor\".\"objectId\" as \"mid\",\n        \"schoolMajor\".\"plan\" as \"plan\",\n        \"schoolClass\".\"name\" as \"class\"\n      from \"Profile\" as \"profile\"\n      left join \"Department\" as \"department\" on \"department\".\"objectId\" = \"profile\".\"department\" \n      left join \"SchoolMajor\" as \"schoolMajor\" on \"schoolMajor\".\"objectId\" = \"profile\".\"SchoolMajor\"\n      left join \"SchoolClass\" as \"schoolClass\" on \"schoolClass\".\"objectId\" = \"profile\".\"schoolClass\"\n      where \"profile\".\"company\" = 'pPZbxElQQo') as \"PR\"\n  left join\n  (select \n    max(\"majors\".\"majorid\") as \"majorid\",\n    max(\"majors\".\"planid\") as \"planid\",\n    max(\"majors\".\"name\") as \"name\",\n    max(\"lessons\".\"objectId\") as \"objectId\",\n    max(\"lessons\".\"title\") as \"title\",\n    max(\"lessons\".\"teacher\") as \"teacher\"\n  from\n  (select \n    \"schoolMajor\".\"objectId\" as \"majorid\",\n     \"schoolMajor\".\"plan\" as \"planid\",\n    \"schoolMajor\".\"name\" as \"name\"\n  from \"SchoolMajor\" as \"schoolMajor\" where \"schoolMajor\".\"company\" = 'pPZbxElQQo') as \"majors\"\n  left join (\n    select \n      \"lessonObjectId\".\"planid\" as \"planid\",\n      \"lessonObjectId\".\"objectId\" as \"objectId\" ,\n        \"lesson\".\"title\" as \"title\" ,\n      \"teacher\".\"name\" as \"teacher\" \n    from\n       (select \n           \"lessons\".\"lesson\"::json->>'objectId' as \"objectId\",\n        \"lessons\".\"planid\" as \"planid\"\n        from (\n        select \n             jsonb_array_elements(\"plan\".\"lessons\") as \"lesson\",\n          \"plan\".\"objectId\" as \"planid\"\n             from \"SchoolPlan\" as \"plan\"\n       left  join \"SchoolMajor\" as \"major\" on \"major\".\"plan\" = \"plan\".\"objectId\" ) as \"lessons\") as \"lessonObjectId\"\n    left join \"Lesson\" as \"lesson\" on \"lessonObjectId\".\"objectId\" =  \"lesson\".\"objectId\"\n    left join \"LessonTeacher\" as \"teacher\" on  \"lesson\".\"schoolTeacher\" = \"teacher\".\"objectId\"\n  ) as \"lessons\" on \"lessons\".\"planid\" = \"majors\".\"planid\"\n  group by \"majorid\", \"objectId\"\n  order by \"majorid\") as \"M\" on  \"PR\".\"mid\" = \"M\".\"majorid\") as \"PInfo\"\n  left join (\n    SELECT \n    \"R\".\"user\" as \"user\",\n    \"R\".\"uid\" as \"uid\",\n    \"R\".\"lid\" as \"lid\",\n    \"R\".\"totalTime\" as \"totalTime\",\n    \"R\".\"downCount\" as \"downCount\",\n    \"totalCount\".\"total\" as \"total\"\n  from \n  (SELECT\n          max(\"profile\".\"name\")  as \"user\",\n          max(\"profile\".\"objectId\")  as \"uid\",\n          max(\"lesson\".\"objectId\") as \"lid\",\n          sum(\"record\".\"time\") as \"totalTime\",\n          sum(case when \"record\".\"status\" = 2  then 1 else 0 end) as \"downCount\"\n       from \"LessonRecord\" as \"record\"\n        left join \"Profile\" as \"profile\" on \"profile\".\"objectId\" = \"record\".\"user\"\n        left join \"Department\" as \"Department\" on \"Department\".\"objectId\" = \"record\".\"department\"\n        left join \"SchoolMajor\" as \"schoolMajor\" on \"schoolMajor\".\"objectId\" = \"profile\".\"SchoolMajor\"\n        left join \"SchoolClass\" as \"schoolClass\" on \"schoolClass\".\"objectId\" = \"profile\".\"schoolClass\"\n        left join \"Lesson\" as \"lesson\" on \"lesson\".\"objectId\" = \"record\".\"lesson\"\n      where \"record\".\"company\" = 'pPZbxElQQo'\n        group by \"record\".\"user\", \"record\".\"lesson\") as \"R\"\n  left join \n  (select\n     count(1) as \"total\",\n     max(\"LessonArticle\".\"objectId\") as \"laid\",\n    max(\"LessonArticle\".\"lesson\") as \"lid\"\n   from \"LessonArticle\"\n   left join \"Lesson\" as \"lesson\" on \"lesson\".\"objectId\" = \"LessonArticle\".\"lesson\"\n   where \"LessonArticle\".\"parent\" is not null and \"LessonArticle\".\"company\" = 'pPZbxElQQo'\n   group by \"LessonArticle\".\"lesson\") as \"totalCount\" on \"totalCount\".\"lid\" = \"R\".\"lid\"\n        ) as \"LRInfo\" on \"LRInfo\".\"uid\" = \"PInfo\".\"uid\" and \"LRInfo\".\"lid\" = \"PInfo\".\"lid\"";
        }
        var baseurl = localStorage.getItem("NOVA_SERVERURL")?localStorage.getItem("NOVA_SERVERURL")+"api/novaql/select":localStorage.getItem("NOVA_SERVERURL")?localStorage.getItem("NOVA_SERVERURL")+"api/novaql/select":"https://server.fmode.cn/api/novaql/select";
        this.http.post(baseurl, { sql: sql }).subscribe(function (res) {
            console.log(res);
            if (res["code"] == 200 && res["data"]) {
                _this.listOfData = res["data"];
            }
        });
    };
    RecordDashboardComponent.prototype.changeSchool = function (ev) {
        return __awaiter(this, void 0, void 0, function () {
            var SchoolMajor, schoolMajors;
            return __generator(this, function (_a) {
                switch (_a.label) {
                    case 0:
                        if (!ev) {
                            this.major = null,
                                this.lesson = null,
                                this.majors = [];
                            this.lessons = [];
                            this.searchAll();
                            return [2 /*return*/];
                        }
                        SchoolMajor = new Parse.Query('SchoolMajor');
                        SchoolMajor.include('plan');
                        this.school = ev;
                        SchoolMajor.equalTo('school', ev);
                        return [4 /*yield*/, SchoolMajor.find()];
                    case 1:
                        schoolMajors = _a.sent();
                        if (schoolMajors && schoolMajors.length > 0) {
                            this.majors = schoolMajors;
                        }
                        return [2 /*return*/];
                }
            });
        });
    };
    RecordDashboardComponent.prototype.changeMajors = function (ev) {
        var _this = this;
        console.log(ev);
        if (ev && ev.id) {
            this.major = ev.id;
        }
        else {
            this.lesson = [];
            this.lessons = [];
            return;
        }
        var lessons = ev.get('plan').get('lessons');
        if (lessons && lessons.length > 0) {
            lessons.forEach(function (lesson) {
                var Lesson = new Parse.Query('Lesson');
                Lesson.get(lesson.id).then(function (res) {
                    if (res && res.id) {
                        _this.lessons.push(res);
                    }
                });
            });
        }
    };
    RecordDashboardComponent.prototype.changeLesson = function (ev) {
        if (ev && ev.id) {
            this.lesson = ev.id;
        }
    };
    // 查询
    RecordDashboardComponent.prototype.search = function () {
        if ((this.student && (!this.school || !this.lesson || !this.major)) || !this.school) {
            alert("请输入完整信息");
            return;
        }
        var sql;
        if (localStorage.getItem('department')) {
            var department = localStorage.getItem('department');
            if (!this.isShcool) {
                // 代理中心
                if (this.school && !this.lesson && !this.major) {
                    sql = "select\n         \"PInfo\".\"uid\" as \"uid\",\n         \"PInfo\".\"mid\" as \"mid\",\n         \"PInfo\".\"lid\" as \"lid\",\n         \"PInfo\".\"user\" as \"user\",\n         \"PInfo\".\"school\" as \"school\",\n         \"PInfo\".\"major\" as \"major\",\n         \"PInfo\".\"class\" as \"class\",\n         \"PInfo\".\"title\" as \"title\",\n         \"LRInfo\".\"totalTime\" as \"totalTime\",\n         \"LRInfo\".\"downCount\" as \"downCount\",\n         \"LRInfo\".\"total\" as \"total\"\n       from \n         (select \n           \"PR\".\"pid\" as \"uid\",\n           \"PR\".\"mid\" as \"mid\",\n           \"PR\".\"name\" as \"user\",\n           \"PR\".\"school\" as \"school\",\n           \"PR\".\"major\" as \"major\",\n           \"PR\".\"class\" as \"class\",\n           \"M\".\"title\" as \"title\",\n           \"M\".\"objectId\" as \"lid\"\n         from\n           (select\n             \"profile\".\"objectId\" as \"pid\",\n             \"profile\".\"name\" as \"name\",\n             \"department\".\"name\" as \"school\",\n             \"schoolMajor\".\"name\" as \"major\",\n             \"schoolMajor\".\"objectId\" as \"mid\",\n             \"schoolMajor\".\"plan\" as \"plan\",\n             \"schoolClass\".\"name\" as \"class\"\n           from \"Profile\" as \"profile\"\n           left join \"Department\" as \"department\" on \"department\".\"objectId\" = \"profile\".\"department\" \n           left join \"SchoolMajor\" as \"schoolMajor\" on \"schoolMajor\".\"objectId\" = \"profile\".\"SchoolMajor\"\n           left join \"SchoolClass\" as \"schoolClass\" on \"schoolClass\".\"objectId\" = \"profile\".\"schoolClass\"\n           where \"profile\".\"company\" = 'pPZbxElQQo' and \"profile\".\"center\" = '" + department + "' ) as \"PR\"\n       left join\n       (select \n         max(\"majors\".\"majorid\") as \"majorid\",\n         max(\"majors\".\"planid\") as \"planid\",\n         max(\"majors\".\"name\") as \"name\",\n         max(\"lessons\".\"objectId\") as \"objectId\",\n         max(\"lessons\".\"title\") as \"title\",\n         max(\"lessons\".\"teacher\") as \"teacher\"\n       from\n       (select \n         \"schoolMajor\".\"objectId\" as \"majorid\",\n          \"schoolMajor\".\"plan\" as \"planid\",\n         \"schoolMajor\".\"name\" as \"name\"\n       from \"SchoolMajor\" as \"schoolMajor\" where \"schoolMajor\".\"company\" = 'pPZbxElQQo') as \"majors\"\n       left join (\n         select \n           \"lessonObjectId\".\"planid\" as \"planid\",\n           \"lessonObjectId\".\"objectId\" as \"objectId\" ,\n             \"lesson\".\"title\" as \"title\" ,\n           \"teacher\".\"name\" as \"teacher\" \n         from\n            (select \n                \"lessons\".\"lesson\"::json->>'objectId' as \"objectId\",\n             \"lessons\".\"planid\" as \"planid\"\n             from (\n             select \n                  jsonb_array_elements(\"plan\".\"lessons\") as \"lesson\",\n               \"plan\".\"objectId\" as \"planid\"\n                  from \"SchoolPlan\" as \"plan\"\n            left  join \"SchoolMajor\" as \"major\" on \"major\".\"plan\" = \"plan\".\"objectId\" ) as \"lessons\") as \"lessonObjectId\"\n         left join \"Lesson\" as \"lesson\" on \"lessonObjectId\".\"objectId\" =  \"lesson\".\"objectId\"\n         left join \"LessonTeacher\" as \"teacher\" on  \"lesson\".\"schoolTeacher\" = \"teacher\".\"objectId\"\n       ) as \"lessons\" on \"lessons\".\"planid\" = \"majors\".\"planid\"\n       group by \"majorid\", \"objectId\"\n       order by \"majorid\") as \"M\" on  \"PR\".\"mid\" = \"M\".\"majorid\") as \"PInfo\"\n       left join (\n         SELECT \n         \"R\".\"user\" as \"user\",\n         \"R\".\"uid\" as \"uid\",\n         \"R\".\"lid\" as \"lid\",\n         \"R\".\"totalTime\" as \"totalTime\",\n         \"R\".\"downCount\" as \"downCount\",\n         \"totalCount\".\"total\" as \"total\"\n       from \n       (SELECT\n               max(\"profile\".\"name\")  as \"user\",\n               max(\"profile\".\"objectId\")  as \"uid\",\n               max(\"lesson\".\"objectId\") as \"lid\",\n               sum(\"record\".\"time\") as \"totalTime\",\n               sum(case when \"record\".\"status\" = 2  then 1 else 0 end) as \"downCount\"\n            from \"LessonRecord\" as \"record\"\n             left join \"Profile\" as \"profile\" on \"profile\".\"objectId\" = \"record\".\"user\"\n             left join \"Department\" as \"Department\" on \"Department\".\"objectId\" = \"record\".\"department\"\n             left join \"SchoolMajor\" as \"schoolMajor\" on \"schoolMajor\".\"objectId\" = \"profile\".\"SchoolMajor\"\n             left join \"SchoolClass\" as \"schoolClass\" on \"schoolClass\".\"objectId\" = \"profile\".\"schoolClass\"\n             left join \"Lesson\" as \"lesson\" on \"lesson\".\"objectId\" = \"record\".\"lesson\"\n           where \"record\".\"company\" = 'pPZbxElQQo'\n             group by \"record\".\"user\", \"record\".\"lesson\") as \"R\"\n       left join \n       (select\n          count(1) as \"total\",\n          max(\"LessonArticle\".\"objectId\") as \"laid\",\n         max(\"LessonArticle\".\"lesson\") as \"lid\"\n        from \"LessonArticle\"\n        left join \"Lesson\" as \"lesson\" on \"lesson\".\"objectId\" = \"LessonArticle\".\"lesson\"\n        where \"LessonArticle\".\"parent\" is not null and \"LessonArticle\".\"company\" = 'pPZbxElQQo'\n        group by \"LessonArticle\".\"lesson\") as \"totalCount\" on \"totalCount\".\"lid\" = \"R\".\"lid\"\n             ) as \"LRInfo\" on \"LRInfo\".\"uid\" = \"PInfo\".\"uid\" and \"LRInfo\".\"lid\" = \"PInfo\".\"lid\"";
                }
                if (this.major && this.school && !this.lesson) {
                    sql = "select\n            \"PInfo\".\"uid\" as \"uid\",\n            \"PInfo\".\"mid\" as \"mid\",\n            \"PInfo\".\"lid\" as \"lid\",\n            \"PInfo\".\"user\" as \"user\",\n            \"PInfo\".\"school\" as \"school\",\n            \"PInfo\".\"major\" as \"major\",\n            \"PInfo\".\"class\" as \"class\",\n            \"PInfo\".\"title\" as \"title\",\n            \"LRInfo\".\"totalTime\" as \"totalTime\",\n            \"LRInfo\".\"downCount\" as \"downCount\",\n            \"LRInfo\".\"total\" as \"total\"\n          from \n            (select \n              \"PR\".\"pid\" as \"uid\",\n              \"PR\".\"mid\" as \"mid\",\n              \"PR\".\"name\" as \"user\",\n              \"PR\".\"school\" as \"school\",\n              \"PR\".\"major\" as \"major\",\n              \"PR\".\"class\" as \"class\",\n              \"M\".\"title\" as \"title\",\n              \"M\".\"objectId\" as \"lid\"\n            from\n              (select\n                \"profile\".\"objectId\" as \"pid\",\n                \"profile\".\"name\" as \"name\",\n                \"department\".\"name\" as \"school\",\n                \"schoolMajor\".\"name\" as \"major\",\n                \"schoolMajor\".\"objectId\" as \"mid\",\n                \"schoolMajor\".\"plan\" as \"plan\",\n                \"schoolClass\".\"name\" as \"class\"\n              from \"Profile\" as \"profile\"\n              left join \"Department\" as \"department\" on \"department\".\"objectId\" = \"profile\".\"department\" \n              left join \"SchoolMajor\" as \"schoolMajor\" on \"schoolMajor\".\"objectId\" = \"profile\".\"SchoolMajor\"\n              left join \"SchoolClass\" as \"schoolClass\" on \"schoolClass\".\"objectId\" = \"profile\".\"schoolClass\"\n              where \"profile\".\"company\" = 'pPZbxElQQo' and \"profile\".\"center\" = '" + department + "' and \"profile\".\"SchoolMajor\" = '" + this.major.id + "') as \"PR\"\n          left join\n          (select \n            max(\"majors\".\"majorid\") as \"majorid\",\n            max(\"majors\".\"planid\") as \"planid\",\n            max(\"majors\".\"name\") as \"name\",\n            max(\"lessons\".\"objectId\") as \"objectId\",\n            max(\"lessons\".\"title\") as \"title\",\n            max(\"lessons\".\"teacher\") as \"teacher\"\n          from\n          (select \n            \"schoolMajor\".\"objectId\" as \"majorid\",\n              \"schoolMajor\".\"plan\" as \"planid\",\n            \"schoolMajor\".\"name\" as \"name\"\n          from \"SchoolMajor\" as \"schoolMajor\" where \"schoolMajor\".\"company\" = 'pPZbxElQQo') as \"majors\"\n          left join (\n            select \n              \"lessonObjectId\".\"planid\" as \"planid\",\n              \"lessonObjectId\".\"objectId\" as \"objectId\" ,\n                \"lesson\".\"title\" as \"title\" ,\n              \"teacher\".\"name\" as \"teacher\" \n            from\n                (select \n                    \"lessons\".\"lesson\"::json->>'objectId' as \"objectId\",\n                \"lessons\".\"planid\" as \"planid\"\n                from (\n                select \n                      jsonb_array_elements(\"plan\".\"lessons\") as \"lesson\",\n                  \"plan\".\"objectId\" as \"planid\"\n                      from \"SchoolPlan\" as \"plan\"\n                left  join \"SchoolMajor\" as \"major\" on \"major\".\"plan\" = \"plan\".\"objectId\" ) as \"lessons\") as \"lessonObjectId\"\n            left join \"Lesson\" as \"lesson\" on \"lessonObjectId\".\"objectId\" =  \"lesson\".\"objectId\"\n            left join \"LessonTeacher\" as \"teacher\" on  \"lesson\".\"schoolTeacher\" = \"teacher\".\"objectId\"\n          ) as \"lessons\" on \"lessons\".\"planid\" = \"majors\".\"planid\"\n          group by \"majorid\", \"objectId\"\n          order by \"majorid\") as \"M\" on  \"PR\".\"mid\" = \"M\".\"majorid\") as \"PInfo\"\n          left join (\n            SELECT \n            \"R\".\"user\" as \"user\",\n            \"R\".\"uid\" as \"uid\",\n            \"R\".\"lid\" as \"lid\",\n            \"R\".\"totalTime\" as \"totalTime\",\n            \"R\".\"downCount\" as \"downCount\",\n            \"totalCount\".\"total\" as \"total\"\n          from \n          (SELECT\n                  max(\"profile\".\"name\")  as \"user\",\n                  max(\"profile\".\"objectId\")  as \"uid\",\n                  max(\"lesson\".\"objectId\") as \"lid\",\n                  sum(\"record\".\"time\") as \"totalTime\",\n                  sum(case when \"record\".\"status\" = 2  then 1 else 0 end) as \"downCount\"\n                from \"LessonRecord\" as \"record\"\n                left join \"Profile\" as \"profile\" on \"profile\".\"objectId\" = \"record\".\"user\"\n                left join \"Department\" as \"Department\" on \"Department\".\"objectId\" = \"record\".\"department\"\n                left join \"SchoolMajor\" as \"schoolMajor\" on \"schoolMajor\".\"objectId\" = \"profile\".\"SchoolMajor\"\n                left join \"SchoolClass\" as \"schoolClass\" on \"schoolClass\".\"objectId\" = \"profile\".\"schoolClass\"\n                left join \"Lesson\" as \"lesson\" on \"lesson\".\"objectId\" = \"record\".\"lesson\"\n              where \"record\".\"company\" = 'pPZbxElQQo'\n                group by \"record\".\"user\", \"record\".\"lesson\") as \"R\"\n          left join \n          (select\n              count(1) as \"total\",\n              max(\"LessonArticle\".\"objectId\") as \"laid\",\n            max(\"LessonArticle\".\"lesson\") as \"lid\"\n            from \"LessonArticle\"\n            left join \"Lesson\" as \"lesson\" on \"lesson\".\"objectId\" = \"LessonArticle\".\"lesson\"\n            where \"LessonArticle\".\"parent\" is not null and \"LessonArticle\".\"company\" = 'pPZbxElQQo'\n            group by \"LessonArticle\".\"lesson\") as \"totalCount\" on \"totalCount\".\"lid\" = \"R\".\"lid\"\n                ) as \"LRInfo\" on \"LRInfo\".\"uid\" = \"PInfo\".\"uid\" and \"LRInfo\".\"lid\" = \"PInfo\".\"lid\"";
                }
                if (this.major && this.school && this.lesson && !this.student) {
                    sql = "select\n        \"PInfo\".\"uid\" as \"uid\",\n        \"PInfo\".\"mid\" as \"mid\",\n        \"PInfo\".\"lid\" as \"lid\",\n        \"PInfo\".\"user\" as \"user\",\n        \"PInfo\".\"school\" as \"school\",\n        \"PInfo\".\"major\" as \"major\",\n        \"PInfo\".\"class\" as \"class\",\n        \"PInfo\".\"title\" as \"title\",\n        \"LRInfo\".\"totalTime\" as \"totalTime\",\n        \"LRInfo\".\"downCount\" as \"downCount\",\n        \"LRInfo\".\"total\" as \"total\"\n      from \n        (select \n          \"PR\".\"pid\" as \"uid\",\n          \"PR\".\"mid\" as \"mid\",\n          \"PR\".\"name\" as \"user\",\n          \"PR\".\"school\" as \"school\",\n          \"PR\".\"major\" as \"major\",\n          \"PR\".\"class\" as \"class\",\n          \"M\".\"title\" as \"title\",\n          \"M\".\"objectId\" as \"lid\"\n        from\n          (select\n            \"profile\".\"objectId\" as \"pid\",\n            \"profile\".\"name\" as \"name\",\n            \"department\".\"name\" as \"school\",\n            \"schoolMajor\".\"name\" as \"major\",\n            \"schoolMajor\".\"objectId\" as \"mid\",\n            \"schoolMajor\".\"plan\" as \"plan\",\n            \"schoolClass\".\"name\" as \"class\"\n          from \"Profile\" as \"profile\"\n          left join \"Department\" as \"department\" on \"department\".\"objectId\" = \"profile\".\"department\" \n          left join \"SchoolMajor\" as \"schoolMajor\" on \"schoolMajor\".\"objectId\" = \"profile\".\"SchoolMajor\"\n          left join \"SchoolClass\" as \"schoolClass\" on \"schoolClass\".\"objectId\" = \"profile\".\"schoolClass\"\n          where \"profile\".\"company\" = 'pPZbxElQQo' and \"profile\".\"center\" = '" + department + "'\n          and \"profile\".\"SchoolMajor\" = '" + this.major.id + "') as \"PR\"\n      left join\n      (select \n        max(\"majors\".\"majorid\") as \"majorid\",\n        max(\"majors\".\"planid\") as \"planid\",\n        max(\"majors\".\"name\") as \"name\",\n        max(\"lessons\".\"objectId\") as \"objectId\",\n        max(\"lessons\".\"title\") as \"title\",\n        max(\"lessons\".\"teacher\") as \"teacher\"\n      from\n      (select \n        \"schoolMajor\".\"objectId\" as \"majorid\",\n          \"schoolMajor\".\"plan\" as \"planid\",\n        \"schoolMajor\".\"name\" as \"name\"\n      from \"SchoolMajor\" as \"schoolMajor\" where \"schoolMajor\".\"company\" = 'pPZbxElQQo') as \"majors\"\n      left join (\n        select \n          \"lessonObjectId\".\"planid\" as \"planid\",\n          \"lessonObjectId\".\"objectId\" as \"objectId\" ,\n            \"lesson\".\"title\" as \"title\" ,\n          \"teacher\".\"name\" as \"teacher\" \n        from\n            (select \n                \"lessons\".\"lesson\"::json->>'objectId' as \"objectId\",\n            \"lessons\".\"planid\" as \"planid\"\n            from (\n            select \n                  jsonb_array_elements(\"plan\".\"lessons\") as \"lesson\",\n              \"plan\".\"objectId\" as \"planid\"\n                  from \"SchoolPlan\" as \"plan\"\n            left  join \"SchoolMajor\" as \"major\" on \"major\".\"plan\" = \"plan\".\"objectId\" ) as \"lessons\") as \"lessonObjectId\"\n        left join \"Lesson\" as \"lesson\" on \"lessonObjectId\".\"objectId\" =  \"lesson\".\"objectId\"\n        left join \"LessonTeacher\" as \"teacher\" on  \"lesson\".\"schoolTeacher\" = \"teacher\".\"objectId\"\n      ) as \"lessons\" on \"lessons\".\"planid\" = \"majors\".\"planid\"\n      group by \"majorid\", \"objectId\"\n      order by \"majorid\") as \"M\" on  \"PR\".\"mid\" = \"M\".\"majorid\"\n      where \"M\".\"objectId\" = '" + this.lesson + "'\n      ) as \"PInfo\"\n      left join (\n        SELECT \n        \"R\".\"user\" as \"user\",\n        \"R\".\"uid\" as \"uid\",\n        \"R\".\"lid\" as \"lid\",\n        \"R\".\"totalTime\" as \"totalTime\",\n        \"R\".\"downCount\" as \"downCount\",\n        \"totalCount\".\"total\" as \"total\"\n      from \n      (SELECT\n              max(\"profile\".\"name\")  as \"user\",\n              max(\"profile\".\"objectId\")  as \"uid\",\n              max(\"lesson\".\"objectId\") as \"lid\",\n              sum(\"record\".\"time\") as \"totalTime\",\n              sum(case when \"record\".\"status\" = 2  then 1 else 0 end) as \"downCount\"\n            from \"LessonRecord\" as \"record\"\n            left join \"Profile\" as \"profile\" on \"profile\".\"objectId\" = \"record\".\"user\"\n            left join \"Department\" as \"Department\" on \"Department\".\"objectId\" = \"record\".\"department\"\n            left join \"SchoolMajor\" as \"schoolMajor\" on \"schoolMajor\".\"objectId\" = \"profile\".\"SchoolMajor\"\n            left join \"SchoolClass\" as \"schoolClass\" on \"schoolClass\".\"objectId\" = \"profile\".\"schoolClass\"\n            left join \"Lesson\" as \"lesson\" on \"lesson\".\"objectId\" = \"record\".\"lesson\"\n          where \"record\".\"company\" = 'pPZbxElQQo'\n            group by \"record\".\"user\", \"record\".\"lesson\") as \"R\"\n      left join \n      (select\n          count(1) as \"total\",\n          max(\"LessonArticle\".\"objectId\") as \"laid\",\n        max(\"LessonArticle\".\"lesson\") as \"lid\"\n        from \"LessonArticle\"\n        left join \"Lesson\" as \"lesson\" on \"lesson\".\"objectId\" = \"LessonArticle\".\"lesson\"\n        where \"LessonArticle\".\"parent\" is not null and \"LessonArticle\".\"company\" = 'pPZbxElQQo'\n        group by \"LessonArticle\".\"lesson\") as \"totalCount\" on \"totalCount\".\"lid\" = \"R\".\"lid\"\n            ) as \"LRInfo\" on \"LRInfo\".\"uid\" = \"PInfo\".\"uid\" and \"LRInfo\".\"lid\" = \"PInfo\".\"lid\"";
                }
                if (this.school && this.major && this.lesson && this.student) {
                    sql = "select\n        \"PInfo\".\"uid\" as \"uid\",\n        \"PInfo\".\"mid\" as \"mid\",\n        \"PInfo\".\"lid\" as \"lid\",\n        \"PInfo\".\"user\" as \"user\",\n        \"PInfo\".\"school\" as \"school\",\n        \"PInfo\".\"major\" as \"major\",\n        \"PInfo\".\"class\" as \"class\",\n        \"PInfo\".\"title\" as \"title\",\n        \"LRInfo\".\"totalTime\" as \"totalTime\",\n        \"LRInfo\".\"downCount\" as \"downCount\",\n        \"LRInfo\".\"total\" as \"total\"\n      from \n        (select \n          \"PR\".\"pid\" as \"uid\",\n          \"PR\".\"mid\" as \"mid\",\n          \"PR\".\"name\" as \"user\",\n          \"PR\".\"school\" as \"school\",\n          \"PR\".\"major\" as \"major\",\n          \"PR\".\"class\" as \"class\",\n          \"M\".\"title\" as \"title\",\n          \"M\".\"objectId\" as \"lid\"\n        from\n          (select\n            \"profile\".\"objectId\" as \"pid\",\n            \"profile\".\"name\" as \"name\",\n            \"department\".\"name\" as \"school\",\n            \"schoolMajor\".\"name\" as \"major\",\n            \"schoolMajor\".\"objectId\" as \"mid\",\n            \"schoolMajor\".\"plan\" as \"plan\",\n            \"schoolClass\".\"name\" as \"class\"\n          from \"Profile\" as \"profile\"\n          left join \"Department\" as \"department\" on \"department\".\"objectId\" = \"profile\".\"department\" \n          left join \"SchoolMajor\" as \"schoolMajor\" on \"schoolMajor\".\"objectId\" = \"profile\".\"SchoolMajor\"\n          left join \"SchoolClass\" as \"schoolClass\" on \"schoolClass\".\"objectId\" = \"profile\".\"schoolClass\"\n          where \"profile\".\"name\" = '" + this.student + "' and \"profile\".\"company\" = 'pPZbxElQQo' and \"profile\".\"center\" = '" + department + "'\n          and \"profile\".\"SchoolMajor\" = '" + this.major.id + "') as \"PR\"\n      left join\n      (select \n        max(\"majors\".\"majorid\") as \"majorid\",\n        max(\"majors\".\"planid\") as \"planid\",\n        max(\"majors\".\"name\") as \"name\",\n        max(\"lessons\".\"objectId\") as \"objectId\",\n        max(\"lessons\".\"title\") as \"title\",\n        max(\"lessons\".\"teacher\") as \"teacher\"\n      from\n      (select \n        \"schoolMajor\".\"objectId\" as \"majorid\",\n          \"schoolMajor\".\"plan\" as \"planid\",\n        \"schoolMajor\".\"name\" as \"name\"\n      from \"SchoolMajor\" as \"schoolMajor\" where \"schoolMajor\".\"company\" = 'pPZbxElQQo') as \"majors\"\n      left join (\n        select \n          \"lessonObjectId\".\"planid\" as \"planid\",\n          \"lessonObjectId\".\"objectId\" as \"objectId\" ,\n            \"lesson\".\"title\" as \"title\" ,\n          \"teacher\".\"name\" as \"teacher\" \n        from\n            (select \n                \"lessons\".\"lesson\"::json->>'objectId' as \"objectId\",\n            \"lessons\".\"planid\" as \"planid\"\n            from (\n            select \n                  jsonb_array_elements(\"plan\".\"lessons\") as \"lesson\",\n              \"plan\".\"objectId\" as \"planid\"\n                  from \"SchoolPlan\" as \"plan\"\n            left  join \"SchoolMajor\" as \"major\" on \"major\".\"plan\" = \"plan\".\"objectId\" ) as \"lessons\") as \"lessonObjectId\"\n        left join \"Lesson\" as \"lesson\" on \"lessonObjectId\".\"objectId\" =  \"lesson\".\"objectId\"\n        left join \"LessonTeacher\" as \"teacher\" on  \"lesson\".\"schoolTeacher\" = \"teacher\".\"objectId\"\n      ) as \"lessons\" on \"lessons\".\"planid\" = \"majors\".\"planid\"\n      group by \"majorid\", \"objectId\"\n      order by \"majorid\") as \"M\" on  \"PR\".\"mid\" = \"M\".\"majorid\"\n      where \"M\".\"objectId\" = '" + this.lesson + "'\n      ) as \"PInfo\"\n      left join (\n        SELECT \n        \"R\".\"user\" as \"user\",\n        \"R\".\"uid\" as \"uid\",\n        \"R\".\"lid\" as \"lid\",\n        \"R\".\"totalTime\" as \"totalTime\",\n        \"R\".\"downCount\" as \"downCount\",\n        \"totalCount\".\"total\" as \"total\"\n      from \n      (SELECT\n              max(\"profile\".\"name\")  as \"user\",\n              max(\"profile\".\"objectId\")  as \"uid\",\n              max(\"lesson\".\"objectId\") as \"lid\",\n              sum(\"record\".\"time\") as \"totalTime\",\n              sum(case when \"record\".\"status\" = 2  then 1 else 0 end) as \"downCount\"\n            from \"LessonRecord\" as \"record\"\n            left join \"Profile\" as \"profile\" on \"profile\".\"objectId\" = \"record\".\"user\"\n            left join \"Department\" as \"Department\" on \"Department\".\"objectId\" = \"record\".\"department\"\n            left join \"SchoolMajor\" as \"schoolMajor\" on \"schoolMajor\".\"objectId\" = \"profile\".\"SchoolMajor\"\n            left join \"SchoolClass\" as \"schoolClass\" on \"schoolClass\".\"objectId\" = \"profile\".\"schoolClass\"\n            left join \"Lesson\" as \"lesson\" on \"lesson\".\"objectId\" = \"record\".\"lesson\"\n          where \"record\".\"company\" = 'pPZbxElQQo'\n            group by \"record\".\"user\", \"record\".\"lesson\") as \"R\"\n      left join \n      (select\n          count(1) as \"total\",\n          max(\"LessonArticle\".\"objectId\") as \"laid\",\n        max(\"LessonArticle\".\"lesson\") as \"lid\"\n        from \"LessonArticle\"\n        left join \"Lesson\" as \"lesson\" on \"lesson\".\"objectId\" = \"LessonArticle\".\"lesson\"\n        where \"LessonArticle\".\"parent\" is not null and \"LessonArticle\".\"company\" = 'pPZbxElQQo'\n        group by \"LessonArticle\".\"lesson\") as \"totalCount\" on \"totalCount\".\"lid\" = \"R\".\"lid\"\n            ) as \"LRInfo\" on \"LRInfo\".\"uid\" = \"PInfo\".\"uid\" and \"LRInfo\".\"lid\" = \"PInfo\".\"lid\"";
                }
            }
            else {
                // 学校
                if (this.school && !this.lesson && !this.major) {
                    sql = "select\n         \"PInfo\".\"uid\" as \"uid\",\n         \"PInfo\".\"mid\" as \"mid\",\n         \"PInfo\".\"lid\" as \"lid\",\n         \"PInfo\".\"user\" as \"user\",\n         \"PInfo\".\"school\" as \"school\",\n         \"PInfo\".\"major\" as \"major\",\n         \"PInfo\".\"class\" as \"class\",\n         \"PInfo\".\"title\" as \"title\",\n         \"LRInfo\".\"totalTime\" as \"totalTime\",\n         \"LRInfo\".\"downCount\" as \"downCount\",\n         \"LRInfo\".\"total\" as \"total\"\n       from \n         (select \n           \"PR\".\"pid\" as \"uid\",\n           \"PR\".\"mid\" as \"mid\",\n           \"PR\".\"name\" as \"user\",\n           \"PR\".\"school\" as \"school\",\n           \"PR\".\"major\" as \"major\",\n           \"PR\".\"class\" as \"class\",\n           \"M\".\"title\" as \"title\",\n           \"M\".\"objectId\" as \"lid\"\n         from\n           (select\n             \"profile\".\"objectId\" as \"pid\",\n             \"profile\".\"name\" as \"name\",\n             \"department\".\"name\" as \"school\",\n             \"schoolMajor\".\"name\" as \"major\",\n             \"schoolMajor\".\"objectId\" as \"mid\",\n             \"schoolMajor\".\"plan\" as \"plan\",\n             \"schoolClass\".\"name\" as \"class\"\n           from \"Profile\" as \"profile\"\n           left join \"Department\" as \"department\" on \"department\".\"objectId\" = \"profile\".\"department\" \n           left join \"SchoolMajor\" as \"schoolMajor\" on \"schoolMajor\".\"objectId\" = \"profile\".\"SchoolMajor\"\n           left join \"SchoolClass\" as \"schoolClass\" on \"schoolClass\".\"objectId\" = \"profile\".\"schoolClass\"\n           where \"profile\".\"company\" = 'pPZbxElQQo' and \"profile\".\"department\" = '" + this.school + "' ) as \"PR\"\n       left join\n       (select \n         max(\"majors\".\"majorid\") as \"majorid\",\n         max(\"majors\".\"planid\") as \"planid\",\n         max(\"majors\".\"name\") as \"name\",\n         max(\"lessons\".\"objectId\") as \"objectId\",\n         max(\"lessons\".\"title\") as \"title\",\n         max(\"lessons\".\"teacher\") as \"teacher\"\n       from\n       (select \n         \"schoolMajor\".\"objectId\" as \"majorid\",\n          \"schoolMajor\".\"plan\" as \"planid\",\n         \"schoolMajor\".\"name\" as \"name\"\n       from \"SchoolMajor\" as \"schoolMajor\" where \"schoolMajor\".\"company\" = 'pPZbxElQQo') as \"majors\"\n       left join (\n         select \n           \"lessonObjectId\".\"planid\" as \"planid\",\n           \"lessonObjectId\".\"objectId\" as \"objectId\" ,\n             \"lesson\".\"title\" as \"title\" ,\n           \"teacher\".\"name\" as \"teacher\" \n         from\n            (select \n                \"lessons\".\"lesson\"::json->>'objectId' as \"objectId\",\n             \"lessons\".\"planid\" as \"planid\"\n             from (\n             select \n                  jsonb_array_elements(\"plan\".\"lessons\") as \"lesson\",\n               \"plan\".\"objectId\" as \"planid\"\n                  from \"SchoolPlan\" as \"plan\"\n            left  join \"SchoolMajor\" as \"major\" on \"major\".\"plan\" = \"plan\".\"objectId\" ) as \"lessons\") as \"lessonObjectId\"\n         left join \"Lesson\" as \"lesson\" on \"lessonObjectId\".\"objectId\" =  \"lesson\".\"objectId\"\n         left join \"LessonTeacher\" as \"teacher\" on  \"lesson\".\"schoolTeacher\" = \"teacher\".\"objectId\"\n       ) as \"lessons\" on \"lessons\".\"planid\" = \"majors\".\"planid\"\n       group by \"majorid\", \"objectId\"\n       order by \"majorid\") as \"M\" on  \"PR\".\"mid\" = \"M\".\"majorid\") as \"PInfo\"\n       left join (\n         SELECT \n         \"R\".\"user\" as \"user\",\n         \"R\".\"uid\" as \"uid\",\n         \"R\".\"lid\" as \"lid\",\n         \"R\".\"totalTime\" as \"totalTime\",\n         \"R\".\"downCount\" as \"downCount\",\n         \"totalCount\".\"total\" as \"total\"\n       from \n       (SELECT\n               max(\"profile\".\"name\")  as \"user\",\n               max(\"profile\".\"objectId\")  as \"uid\",\n               max(\"lesson\".\"objectId\") as \"lid\",\n               sum(\"record\".\"time\") as \"totalTime\",\n               sum(case when \"record\".\"status\" = 2  then 1 else 0 end) as \"downCount\"\n            from \"LessonRecord\" as \"record\"\n             left join \"Profile\" as \"profile\" on \"profile\".\"objectId\" = \"record\".\"user\"\n             left join \"Department\" as \"Department\" on \"Department\".\"objectId\" = \"record\".\"department\"\n             left join \"SchoolMajor\" as \"schoolMajor\" on \"schoolMajor\".\"objectId\" = \"profile\".\"SchoolMajor\"\n             left join \"SchoolClass\" as \"schoolClass\" on \"schoolClass\".\"objectId\" = \"profile\".\"schoolClass\"\n             left join \"Lesson\" as \"lesson\" on \"lesson\".\"objectId\" = \"record\".\"lesson\"\n           where \"record\".\"company\" = 'pPZbxElQQo'\n             group by \"record\".\"user\", \"record\".\"lesson\") as \"R\"\n       left join \n       (select\n          count(1) as \"total\",\n          max(\"LessonArticle\".\"objectId\") as \"laid\",\n         max(\"LessonArticle\".\"lesson\") as \"lid\"\n        from \"LessonArticle\"\n        left join \"Lesson\" as \"lesson\" on \"lesson\".\"objectId\" = \"LessonArticle\".\"lesson\"\n        where \"LessonArticle\".\"parent\" is not null and \"LessonArticle\".\"company\" = 'pPZbxElQQo'\n        group by \"LessonArticle\".\"lesson\") as \"totalCount\" on \"totalCount\".\"lid\" = \"R\".\"lid\"\n             ) as \"LRInfo\" on \"LRInfo\".\"uid\" = \"PInfo\".\"uid\" and \"LRInfo\".\"lid\" = \"PInfo\".\"lid\"";
                }
                if (this.major && this.school && !this.lesson) {
                    sql = "select\n          \"PInfo\".\"uid\" as \"uid\",\n          \"PInfo\".\"mid\" as \"mid\",\n          \"PInfo\".\"lid\" as \"lid\",\n          \"PInfo\".\"user\" as \"user\",\n          \"PInfo\".\"school\" as \"school\",\n          \"PInfo\".\"major\" as \"major\",\n          \"PInfo\".\"class\" as \"class\",\n          \"PInfo\".\"title\" as \"title\",\n          \"LRInfo\".\"totalTime\" as \"totalTime\",\n          \"LRInfo\".\"downCount\" as \"downCount\",\n          \"LRInfo\".\"total\" as \"total\"\n        from \n          (select \n            \"PR\".\"pid\" as \"uid\",\n            \"PR\".\"mid\" as \"mid\",\n            \"PR\".\"name\" as \"user\",\n            \"PR\".\"school\" as \"school\",\n            \"PR\".\"major\" as \"major\",\n            \"PR\".\"class\" as \"class\",\n            \"M\".\"title\" as \"title\",\n            \"M\".\"objectId\" as \"lid\"\n          from\n            (select\n              \"profile\".\"objectId\" as \"pid\",\n              \"profile\".\"name\" as \"name\",\n              \"department\".\"name\" as \"school\",\n              \"schoolMajor\".\"name\" as \"major\",\n              \"schoolMajor\".\"objectId\" as \"mid\",\n              \"schoolMajor\".\"plan\" as \"plan\",\n              \"schoolClass\".\"name\" as \"class\"\n            from \"Profile\" as \"profile\"\n            left join \"Department\" as \"department\" on \"department\".\"objectId\" = \"profile\".\"department\" \n            left join \"SchoolMajor\" as \"schoolMajor\" on \"schoolMajor\".\"objectId\" = \"profile\".\"SchoolMajor\"\n            left join \"SchoolClass\" as \"schoolClass\" on \"schoolClass\".\"objectId\" = \"profile\".\"schoolClass\"\n            where \"profile\".\"company\" = 'pPZbxElQQo' and \"profile\".\"department\" = '" + this.school + "' and \"profile\".\"SchoolMajor\" = '" + this.major.id + "') as \"PR\"\n        left join\n        (select \n          max(\"majors\".\"majorid\") as \"majorid\",\n          max(\"majors\".\"planid\") as \"planid\",\n          max(\"majors\".\"name\") as \"name\",\n          max(\"lessons\".\"objectId\") as \"objectId\",\n          max(\"lessons\".\"title\") as \"title\",\n          max(\"lessons\".\"teacher\") as \"teacher\"\n        from\n        (select \n          \"schoolMajor\".\"objectId\" as \"majorid\",\n            \"schoolMajor\".\"plan\" as \"planid\",\n          \"schoolMajor\".\"name\" as \"name\"\n        from \"SchoolMajor\" as \"schoolMajor\" where \"schoolMajor\".\"company\" = 'pPZbxElQQo') as \"majors\"\n        left join (\n          select \n            \"lessonObjectId\".\"planid\" as \"planid\",\n            \"lessonObjectId\".\"objectId\" as \"objectId\" ,\n              \"lesson\".\"title\" as \"title\" ,\n            \"teacher\".\"name\" as \"teacher\" \n          from\n              (select \n                  \"lessons\".\"lesson\"::json->>'objectId' as \"objectId\",\n              \"lessons\".\"planid\" as \"planid\"\n              from (\n              select \n                    jsonb_array_elements(\"plan\".\"lessons\") as \"lesson\",\n                \"plan\".\"objectId\" as \"planid\"\n                    from \"SchoolPlan\" as \"plan\"\n              left  join \"SchoolMajor\" as \"major\" on \"major\".\"plan\" = \"plan\".\"objectId\" ) as \"lessons\") as \"lessonObjectId\"\n          left join \"Lesson\" as \"lesson\" on \"lessonObjectId\".\"objectId\" =  \"lesson\".\"objectId\"\n          left join \"LessonTeacher\" as \"teacher\" on  \"lesson\".\"schoolTeacher\" = \"teacher\".\"objectId\"\n        ) as \"lessons\" on \"lessons\".\"planid\" = \"majors\".\"planid\"\n        group by \"majorid\", \"objectId\"\n        order by \"majorid\") as \"M\" on  \"PR\".\"mid\" = \"M\".\"majorid\") as \"PInfo\"\n        left join (\n          SELECT \n          \"R\".\"user\" as \"user\",\n          \"R\".\"uid\" as \"uid\",\n          \"R\".\"lid\" as \"lid\",\n          \"R\".\"totalTime\" as \"totalTime\",\n          \"R\".\"downCount\" as \"downCount\",\n          \"totalCount\".\"total\" as \"total\"\n        from \n        (SELECT\n                max(\"profile\".\"name\")  as \"user\",\n                max(\"profile\".\"objectId\")  as \"uid\",\n                max(\"lesson\".\"objectId\") as \"lid\",\n                sum(\"record\".\"time\") as \"totalTime\",\n                sum(case when \"record\".\"status\" = 2  then 1 else 0 end) as \"downCount\"\n              from \"LessonRecord\" as \"record\"\n              left join \"Profile\" as \"profile\" on \"profile\".\"objectId\" = \"record\".\"user\"\n              left join \"Department\" as \"Department\" on \"Department\".\"objectId\" = \"record\".\"department\"\n              left join \"SchoolMajor\" as \"schoolMajor\" on \"schoolMajor\".\"objectId\" = \"profile\".\"SchoolMajor\"\n              left join \"SchoolClass\" as \"schoolClass\" on \"schoolClass\".\"objectId\" = \"profile\".\"schoolClass\"\n              left join \"Lesson\" as \"lesson\" on \"lesson\".\"objectId\" = \"record\".\"lesson\"\n            where \"record\".\"company\" = 'pPZbxElQQo'\n              group by \"record\".\"user\", \"record\".\"lesson\") as \"R\"\n        left join \n        (select\n            count(1) as \"total\",\n            max(\"LessonArticle\".\"objectId\") as \"laid\",\n          max(\"LessonArticle\".\"lesson\") as \"lid\"\n          from \"LessonArticle\"\n          left join \"Lesson\" as \"lesson\" on \"lesson\".\"objectId\" = \"LessonArticle\".\"lesson\"\n          where \"LessonArticle\".\"parent\" is not null and \"LessonArticle\".\"company\" = 'pPZbxElQQo'\n          group by \"LessonArticle\".\"lesson\") as \"totalCount\" on \"totalCount\".\"lid\" = \"R\".\"lid\"\n              ) as \"LRInfo\" on \"LRInfo\".\"uid\" = \"PInfo\".\"uid\" and \"LRInfo\".\"lid\" = \"PInfo\".\"lid\"";
                }
                if (this.major && this.school && this.lesson && !this.student) {
                    sql = "select\n        \"PInfo\".\"uid\" as \"uid\",\n        \"PInfo\".\"mid\" as \"mid\",\n        \"PInfo\".\"lid\" as \"lid\",\n        \"PInfo\".\"user\" as \"user\",\n        \"PInfo\".\"school\" as \"school\",\n        \"PInfo\".\"major\" as \"major\",\n        \"PInfo\".\"class\" as \"class\",\n        \"PInfo\".\"title\" as \"title\",\n        \"LRInfo\".\"totalTime\" as \"totalTime\",\n        \"LRInfo\".\"downCount\" as \"downCount\",\n        \"LRInfo\".\"total\" as \"total\"\n      from \n        (select \n          \"PR\".\"pid\" as \"uid\",\n          \"PR\".\"mid\" as \"mid\",\n          \"PR\".\"name\" as \"user\",\n          \"PR\".\"school\" as \"school\",\n          \"PR\".\"major\" as \"major\",\n          \"PR\".\"class\" as \"class\",\n          \"M\".\"title\" as \"title\",\n          \"M\".\"objectId\" as \"lid\"\n        from\n          (select\n            \"profile\".\"objectId\" as \"pid\",\n            \"profile\".\"name\" as \"name\",\n            \"department\".\"name\" as \"school\",\n            \"schoolMajor\".\"name\" as \"major\",\n            \"schoolMajor\".\"objectId\" as \"mid\",\n            \"schoolMajor\".\"plan\" as \"plan\",\n            \"schoolClass\".\"name\" as \"class\"\n          from \"Profile\" as \"profile\"\n          left join \"Department\" as \"department\" on \"department\".\"objectId\" = \"profile\".\"department\" \n          left join \"SchoolMajor\" as \"schoolMajor\" on \"schoolMajor\".\"objectId\" = \"profile\".\"SchoolMajor\"\n          left join \"SchoolClass\" as \"schoolClass\" on \"schoolClass\".\"objectId\" = \"profile\".\"schoolClass\"\n          where \"profile\".\"company\" = 'pPZbxElQQo' and \"profile\".\"department\" = '" + this.school + "'\n          and \"profile\".\"SchoolMajor\" = '" + this.major.id + "') as \"PR\"\n      left join\n      (select \n        max(\"majors\".\"majorid\") as \"majorid\",\n        max(\"majors\".\"planid\") as \"planid\",\n        max(\"majors\".\"name\") as \"name\",\n        max(\"lessons\".\"objectId\") as \"objectId\",\n        max(\"lessons\".\"title\") as \"title\",\n        max(\"lessons\".\"teacher\") as \"teacher\"\n      from\n      (select \n        \"schoolMajor\".\"objectId\" as \"majorid\",\n          \"schoolMajor\".\"plan\" as \"planid\",\n        \"schoolMajor\".\"name\" as \"name\"\n      from \"SchoolMajor\" as \"schoolMajor\" where \"schoolMajor\".\"company\" = 'pPZbxElQQo') as \"majors\"\n      left join (\n        select \n          \"lessonObjectId\".\"planid\" as \"planid\",\n          \"lessonObjectId\".\"objectId\" as \"objectId\" ,\n            \"lesson\".\"title\" as \"title\" ,\n          \"teacher\".\"name\" as \"teacher\" \n        from\n            (select \n                \"lessons\".\"lesson\"::json->>'objectId' as \"objectId\",\n            \"lessons\".\"planid\" as \"planid\"\n            from (\n            select \n                  jsonb_array_elements(\"plan\".\"lessons\") as \"lesson\",\n              \"plan\".\"objectId\" as \"planid\"\n                  from \"SchoolPlan\" as \"plan\"\n            left  join \"SchoolMajor\" as \"major\" on \"major\".\"plan\" = \"plan\".\"objectId\" ) as \"lessons\") as \"lessonObjectId\"\n        left join \"Lesson\" as \"lesson\" on \"lessonObjectId\".\"objectId\" =  \"lesson\".\"objectId\"\n        left join \"LessonTeacher\" as \"teacher\" on  \"lesson\".\"schoolTeacher\" = \"teacher\".\"objectId\"\n      ) as \"lessons\" on \"lessons\".\"planid\" = \"majors\".\"planid\"\n      group by \"majorid\", \"objectId\"\n      order by \"majorid\") as \"M\" on  \"PR\".\"mid\" = \"M\".\"majorid\"\n      where \"M\".\"objectId\" = '" + this.lesson + "'\n      ) as \"PInfo\"\n      left join (\n        SELECT \n        \"R\".\"user\" as \"user\",\n        \"R\".\"uid\" as \"uid\",\n        \"R\".\"lid\" as \"lid\",\n        \"R\".\"totalTime\" as \"totalTime\",\n        \"R\".\"downCount\" as \"downCount\",\n        \"totalCount\".\"total\" as \"total\"\n      from \n      (SELECT\n              max(\"profile\".\"name\")  as \"user\",\n              max(\"profile\".\"objectId\")  as \"uid\",\n              max(\"lesson\".\"objectId\") as \"lid\",\n              sum(\"record\".\"time\") as \"totalTime\",\n              sum(case when \"record\".\"status\" = 2  then 1 else 0 end) as \"downCount\"\n            from \"LessonRecord\" as \"record\"\n            left join \"Profile\" as \"profile\" on \"profile\".\"objectId\" = \"record\".\"user\"\n            left join \"Department\" as \"Department\" on \"Department\".\"objectId\" = \"record\".\"department\"\n            left join \"SchoolMajor\" as \"schoolMajor\" on \"schoolMajor\".\"objectId\" = \"profile\".\"SchoolMajor\"\n            left join \"SchoolClass\" as \"schoolClass\" on \"schoolClass\".\"objectId\" = \"profile\".\"schoolClass\"\n            left join \"Lesson\" as \"lesson\" on \"lesson\".\"objectId\" = \"record\".\"lesson\"\n          where \"record\".\"company\" = 'pPZbxElQQo'\n            group by \"record\".\"user\", \"record\".\"lesson\") as \"R\"\n      left join \n      (select\n          count(1) as \"total\",\n          max(\"LessonArticle\".\"objectId\") as \"laid\",\n        max(\"LessonArticle\".\"lesson\") as \"lid\"\n        from \"LessonArticle\"\n        left join \"Lesson\" as \"lesson\" on \"lesson\".\"objectId\" = \"LessonArticle\".\"lesson\"\n        where \"LessonArticle\".\"parent\" is not null and \"LessonArticle\".\"company\" = 'pPZbxElQQo'\n        group by \"LessonArticle\".\"lesson\") as \"totalCount\" on \"totalCount\".\"lid\" = \"R\".\"lid\"\n            ) as \"LRInfo\" on \"LRInfo\".\"uid\" = \"PInfo\".\"uid\" and \"LRInfo\".\"lid\" = \"PInfo\".\"lid\"";
                }
                if (this.school && this.major && this.lesson && this.student) {
                    sql = "select\n        \"PInfo\".\"uid\" as \"uid\",\n        \"PInfo\".\"mid\" as \"mid\",\n        \"PInfo\".\"lid\" as \"lid\",\n        \"PInfo\".\"user\" as \"user\",\n        \"PInfo\".\"school\" as \"school\",\n        \"PInfo\".\"major\" as \"major\",\n        \"PInfo\".\"class\" as \"class\",\n        \"PInfo\".\"title\" as \"title\",\n        \"LRInfo\".\"totalTime\" as \"totalTime\",\n        \"LRInfo\".\"downCount\" as \"downCount\",\n        \"LRInfo\".\"total\" as \"total\"\n      from \n        (select \n          \"PR\".\"pid\" as \"uid\",\n          \"PR\".\"mid\" as \"mid\",\n          \"PR\".\"name\" as \"user\",\n          \"PR\".\"school\" as \"school\",\n          \"PR\".\"major\" as \"major\",\n          \"PR\".\"class\" as \"class\",\n          \"M\".\"title\" as \"title\",\n          \"M\".\"objectId\" as \"lid\"\n        from\n          (select\n            \"profile\".\"objectId\" as \"pid\",\n            \"profile\".\"name\" as \"name\",\n            \"department\".\"name\" as \"school\",\n            \"schoolMajor\".\"name\" as \"major\",\n            \"schoolMajor\".\"objectId\" as \"mid\",\n            \"schoolMajor\".\"plan\" as \"plan\",\n            \"schoolClass\".\"name\" as \"class\"\n          from \"Profile\" as \"profile\"\n          left join \"Department\" as \"department\" on \"department\".\"objectId\" = \"profile\".\"department\" \n          left join \"SchoolMajor\" as \"schoolMajor\" on \"schoolMajor\".\"objectId\" = \"profile\".\"SchoolMajor\"\n          left join \"SchoolClass\" as \"schoolClass\" on \"schoolClass\".\"objectId\" = \"profile\".\"schoolClass\"\n          where \"profile\".\"name\" = '" + this.student + "' and \"profile\".\"company\" = 'pPZbxElQQo' and \"profile\".\"department\" = '" + this.school + "'\n          and \"profile\".\"SchoolMajor\" = '" + this.major.id + "') as \"PR\"\n      left join\n      (select \n        max(\"majors\".\"majorid\") as \"majorid\",\n        max(\"majors\".\"planid\") as \"planid\",\n        max(\"majors\".\"name\") as \"name\",\n        max(\"lessons\".\"objectId\") as \"objectId\",\n        max(\"lessons\".\"title\") as \"title\",\n        max(\"lessons\".\"teacher\") as \"teacher\"\n      from\n      (select \n        \"schoolMajor\".\"objectId\" as \"majorid\",\n          \"schoolMajor\".\"plan\" as \"planid\",\n        \"schoolMajor\".\"name\" as \"name\"\n      from \"SchoolMajor\" as \"schoolMajor\" where \"schoolMajor\".\"company\" = 'pPZbxElQQo') as \"majors\"\n      left join (\n        select \n          \"lessonObjectId\".\"planid\" as \"planid\",\n          \"lessonObjectId\".\"objectId\" as \"objectId\" ,\n            \"lesson\".\"title\" as \"title\" ,\n          \"teacher\".\"name\" as \"teacher\" \n        from\n            (select \n                \"lessons\".\"lesson\"::json->>'objectId' as \"objectId\",\n            \"lessons\".\"planid\" as \"planid\"\n            from (\n            select \n                  jsonb_array_elements(\"plan\".\"lessons\") as \"lesson\",\n              \"plan\".\"objectId\" as \"planid\"\n                  from \"SchoolPlan\" as \"plan\"\n            left  join \"SchoolMajor\" as \"major\" on \"major\".\"plan\" = \"plan\".\"objectId\" ) as \"lessons\") as \"lessonObjectId\"\n        left join \"Lesson\" as \"lesson\" on \"lessonObjectId\".\"objectId\" =  \"lesson\".\"objectId\"\n        left join \"LessonTeacher\" as \"teacher\" on  \"lesson\".\"schoolTeacher\" = \"teacher\".\"objectId\"\n      ) as \"lessons\" on \"lessons\".\"planid\" = \"majors\".\"planid\"\n      group by \"majorid\", \"objectId\"\n      order by \"majorid\") as \"M\" on  \"PR\".\"mid\" = \"M\".\"majorid\"\n      where \"M\".\"objectId\" = '" + this.lesson + "'\n      ) as \"PInfo\"\n      left join (\n        SELECT \n        \"R\".\"user\" as \"user\",\n        \"R\".\"uid\" as \"uid\",\n        \"R\".\"lid\" as \"lid\",\n        \"R\".\"totalTime\" as \"totalTime\",\n        \"R\".\"downCount\" as \"downCount\",\n        \"totalCount\".\"total\" as \"total\"\n      from \n      (SELECT\n              max(\"profile\".\"name\")  as \"user\",\n              max(\"profile\".\"objectId\")  as \"uid\",\n              max(\"lesson\".\"objectId\") as \"lid\",\n              sum(\"record\".\"time\") as \"totalTime\",\n              sum(case when \"record\".\"status\" = 2  then 1 else 0 end) as \"downCount\"\n            from \"LessonRecord\" as \"record\"\n            left join \"Profile\" as \"profile\" on \"profile\".\"objectId\" = \"record\".\"user\"\n            left join \"Department\" as \"Department\" on \"Department\".\"objectId\" = \"record\".\"department\"\n            left join \"SchoolMajor\" as \"schoolMajor\" on \"schoolMajor\".\"objectId\" = \"profile\".\"SchoolMajor\"\n            left join \"SchoolClass\" as \"schoolClass\" on \"schoolClass\".\"objectId\" = \"profile\".\"schoolClass\"\n            left join \"Lesson\" as \"lesson\" on \"lesson\".\"objectId\" = \"record\".\"lesson\"\n          where \"record\".\"company\" = 'pPZbxElQQo'\n            group by \"record\".\"user\", \"record\".\"lesson\") as \"R\"\n      left join \n      (select\n          count(1) as \"total\",\n          max(\"LessonArticle\".\"objectId\") as \"laid\",\n        max(\"LessonArticle\".\"lesson\") as \"lid\"\n        from \"LessonArticle\"\n        left join \"Lesson\" as \"lesson\" on \"lesson\".\"objectId\" = \"LessonArticle\".\"lesson\"\n        where \"LessonArticle\".\"parent\" is not null and \"LessonArticle\".\"company\" = 'pPZbxElQQo'\n        group by \"LessonArticle\".\"lesson\") as \"totalCount\" on \"totalCount\".\"lid\" = \"R\".\"lid\"\n            ) as \"LRInfo\" on \"LRInfo\".\"uid\" = \"PInfo\".\"uid\" and \"LRInfo\".\"lid\" = \"PInfo\".\"lid\"";
                }
            }
        }
        else {
            // 总部
            if (this.school && !this.lesson && !this.major) {
                sql = "select\n     \"PInfo\".\"uid\" as \"uid\",\n     \"PInfo\".\"mid\" as \"mid\",\n     \"PInfo\".\"lid\" as \"lid\",\n     \"PInfo\".\"user\" as \"user\",\n     \"PInfo\".\"school\" as \"school\",\n     \"PInfo\".\"major\" as \"major\",\n     \"PInfo\".\"class\" as \"class\",\n     \"PInfo\".\"title\" as \"title\",\n     \"LRInfo\".\"totalTime\" as \"totalTime\",\n     \"LRInfo\".\"downCount\" as \"downCount\",\n     \"LRInfo\".\"total\" as \"total\"\n   from \n     (select \n       \"PR\".\"pid\" as \"uid\",\n       \"PR\".\"mid\" as \"mid\",\n       \"PR\".\"name\" as \"user\",\n       \"PR\".\"school\" as \"school\",\n       \"PR\".\"major\" as \"major\",\n       \"PR\".\"class\" as \"class\",\n       \"M\".\"title\" as \"title\",\n       \"M\".\"objectId\" as \"lid\"\n     from\n       (select\n         \"profile\".\"objectId\" as \"pid\",\n         \"profile\".\"name\" as \"name\",\n         \"department\".\"name\" as \"school\",\n         \"schoolMajor\".\"name\" as \"major\",\n         \"schoolMajor\".\"objectId\" as \"mid\",\n         \"schoolMajor\".\"plan\" as \"plan\",\n         \"schoolClass\".\"name\" as \"class\"\n       from \"Profile\" as \"profile\"\n       left join \"Department\" as \"department\" on \"department\".\"objectId\" = \"profile\".\"department\" \n       left join \"SchoolMajor\" as \"schoolMajor\" on \"schoolMajor\".\"objectId\" = \"profile\".\"SchoolMajor\"\n       left join \"SchoolClass\" as \"schoolClass\" on \"schoolClass\".\"objectId\" = \"profile\".\"schoolClass\"\n       where \"profile\".\"company\" = 'pPZbxElQQo' and \"profile\".\"department\" = '" + this.school + "' ) as \"PR\"\n   left join\n   (select \n     max(\"majors\".\"majorid\") as \"majorid\",\n     max(\"majors\".\"planid\") as \"planid\",\n     max(\"majors\".\"name\") as \"name\",\n     max(\"lessons\".\"objectId\") as \"objectId\",\n     max(\"lessons\".\"title\") as \"title\",\n     max(\"lessons\".\"teacher\") as \"teacher\"\n   from\n   (select \n     \"schoolMajor\".\"objectId\" as \"majorid\",\n      \"schoolMajor\".\"plan\" as \"planid\",\n     \"schoolMajor\".\"name\" as \"name\"\n   from \"SchoolMajor\" as \"schoolMajor\" where \"schoolMajor\".\"company\" = 'pPZbxElQQo') as \"majors\"\n   left join (\n     select \n       \"lessonObjectId\".\"planid\" as \"planid\",\n       \"lessonObjectId\".\"objectId\" as \"objectId\" ,\n         \"lesson\".\"title\" as \"title\" ,\n       \"teacher\".\"name\" as \"teacher\" \n     from\n        (select \n            \"lessons\".\"lesson\"::json->>'objectId' as \"objectId\",\n         \"lessons\".\"planid\" as \"planid\"\n         from (\n         select \n              jsonb_array_elements(\"plan\".\"lessons\") as \"lesson\",\n           \"plan\".\"objectId\" as \"planid\"\n              from \"SchoolPlan\" as \"plan\"\n        left  join \"SchoolMajor\" as \"major\" on \"major\".\"plan\" = \"plan\".\"objectId\" ) as \"lessons\") as \"lessonObjectId\"\n     left join \"Lesson\" as \"lesson\" on \"lessonObjectId\".\"objectId\" =  \"lesson\".\"objectId\"\n     left join \"LessonTeacher\" as \"teacher\" on  \"lesson\".\"schoolTeacher\" = \"teacher\".\"objectId\"\n   ) as \"lessons\" on \"lessons\".\"planid\" = \"majors\".\"planid\"\n   group by \"majorid\", \"objectId\"\n   order by \"majorid\") as \"M\" on  \"PR\".\"mid\" = \"M\".\"majorid\") as \"PInfo\"\n   left join (\n     SELECT \n     \"R\".\"user\" as \"user\",\n     \"R\".\"uid\" as \"uid\",\n     \"R\".\"lid\" as \"lid\",\n     \"R\".\"totalTime\" as \"totalTime\",\n     \"R\".\"downCount\" as \"downCount\",\n     \"totalCount\".\"total\" as \"total\"\n   from \n   (SELECT\n           max(\"profile\".\"name\")  as \"user\",\n           max(\"profile\".\"objectId\")  as \"uid\",\n           max(\"lesson\".\"objectId\") as \"lid\",\n           sum(\"record\".\"time\") as \"totalTime\",\n           sum(case when \"record\".\"status\" = 2  then 1 else 0 end) as \"downCount\"\n        from \"LessonRecord\" as \"record\"\n         left join \"Profile\" as \"profile\" on \"profile\".\"objectId\" = \"record\".\"user\"\n         left join \"Department\" as \"Department\" on \"Department\".\"objectId\" = \"record\".\"department\"\n         left join \"SchoolMajor\" as \"schoolMajor\" on \"schoolMajor\".\"objectId\" = \"profile\".\"SchoolMajor\"\n         left join \"SchoolClass\" as \"schoolClass\" on \"schoolClass\".\"objectId\" = \"profile\".\"schoolClass\"\n         left join \"Lesson\" as \"lesson\" on \"lesson\".\"objectId\" = \"record\".\"lesson\"\n       where \"record\".\"company\" = 'pPZbxElQQo'\n         group by \"record\".\"user\", \"record\".\"lesson\") as \"R\"\n   left join \n   (select\n      count(1) as \"total\",\n      max(\"LessonArticle\".\"objectId\") as \"laid\",\n     max(\"LessonArticle\".\"lesson\") as \"lid\"\n    from \"LessonArticle\"\n    left join \"Lesson\" as \"lesson\" on \"lesson\".\"objectId\" = \"LessonArticle\".\"lesson\"\n    where \"LessonArticle\".\"parent\" is not null and \"LessonArticle\".\"company\" = 'pPZbxElQQo'\n    group by \"LessonArticle\".\"lesson\") as \"totalCount\" on \"totalCount\".\"lid\" = \"R\".\"lid\"\n         ) as \"LRInfo\" on \"LRInfo\".\"uid\" = \"PInfo\".\"uid\" and \"LRInfo\".\"lid\" = \"PInfo\".\"lid\"";
            }
            if (this.major && this.school && !this.lesson) {
                sql = "select\n        \"PInfo\".\"uid\" as \"uid\",\n        \"PInfo\".\"mid\" as \"mid\",\n        \"PInfo\".\"lid\" as \"lid\",\n        \"PInfo\".\"user\" as \"user\",\n        \"PInfo\".\"school\" as \"school\",\n        \"PInfo\".\"major\" as \"major\",\n        \"PInfo\".\"class\" as \"class\",\n        \"PInfo\".\"title\" as \"title\",\n        \"LRInfo\".\"totalTime\" as \"totalTime\",\n        \"LRInfo\".\"downCount\" as \"downCount\",\n        \"LRInfo\".\"total\" as \"total\"\n      from \n        (select \n          \"PR\".\"pid\" as \"uid\",\n          \"PR\".\"mid\" as \"mid\",\n          \"PR\".\"name\" as \"user\",\n          \"PR\".\"school\" as \"school\",\n          \"PR\".\"major\" as \"major\",\n          \"PR\".\"class\" as \"class\",\n          \"M\".\"title\" as \"title\",\n          \"M\".\"objectId\" as \"lid\"\n        from\n          (select\n            \"profile\".\"objectId\" as \"pid\",\n            \"profile\".\"name\" as \"name\",\n            \"department\".\"name\" as \"school\",\n            \"schoolMajor\".\"name\" as \"major\",\n            \"schoolMajor\".\"objectId\" as \"mid\",\n            \"schoolMajor\".\"plan\" as \"plan\",\n            \"schoolClass\".\"name\" as \"class\"\n          from \"Profile\" as \"profile\"\n          left join \"Department\" as \"department\" on \"department\".\"objectId\" = \"profile\".\"department\" \n          left join \"SchoolMajor\" as \"schoolMajor\" on \"schoolMajor\".\"objectId\" = \"profile\".\"SchoolMajor\"\n          left join \"SchoolClass\" as \"schoolClass\" on \"schoolClass\".\"objectId\" = \"profile\".\"schoolClass\"\n          where \"profile\".\"company\" = 'pPZbxElQQo' and \"profile\".\"department\" = '" + this.school + "' and \"profile\".\"SchoolMajor\" = '" + this.major.id + "') as \"PR\"\n      left join\n      (select \n        max(\"majors\".\"majorid\") as \"majorid\",\n        max(\"majors\".\"planid\") as \"planid\",\n        max(\"majors\".\"name\") as \"name\",\n        max(\"lessons\".\"objectId\") as \"objectId\",\n        max(\"lessons\".\"title\") as \"title\",\n        max(\"lessons\".\"teacher\") as \"teacher\"\n      from\n      (select \n        \"schoolMajor\".\"objectId\" as \"majorid\",\n          \"schoolMajor\".\"plan\" as \"planid\",\n        \"schoolMajor\".\"name\" as \"name\"\n      from \"SchoolMajor\" as \"schoolMajor\" where \"schoolMajor\".\"company\" = 'pPZbxElQQo') as \"majors\"\n      left join (\n        select \n          \"lessonObjectId\".\"planid\" as \"planid\",\n          \"lessonObjectId\".\"objectId\" as \"objectId\" ,\n            \"lesson\".\"title\" as \"title\" ,\n          \"teacher\".\"name\" as \"teacher\" \n        from\n            (select \n                \"lessons\".\"lesson\"::json->>'objectId' as \"objectId\",\n            \"lessons\".\"planid\" as \"planid\"\n            from (\n            select \n                  jsonb_array_elements(\"plan\".\"lessons\") as \"lesson\",\n              \"plan\".\"objectId\" as \"planid\"\n                  from \"SchoolPlan\" as \"plan\"\n            left  join \"SchoolMajor\" as \"major\" on \"major\".\"plan\" = \"plan\".\"objectId\" ) as \"lessons\") as \"lessonObjectId\"\n        left join \"Lesson\" as \"lesson\" on \"lessonObjectId\".\"objectId\" =  \"lesson\".\"objectId\"\n        left join \"LessonTeacher\" as \"teacher\" on  \"lesson\".\"schoolTeacher\" = \"teacher\".\"objectId\"\n      ) as \"lessons\" on \"lessons\".\"planid\" = \"majors\".\"planid\"\n      group by \"majorid\", \"objectId\"\n      order by \"majorid\") as \"M\" on  \"PR\".\"mid\" = \"M\".\"majorid\") as \"PInfo\"\n      left join (\n        SELECT \n        \"R\".\"user\" as \"user\",\n        \"R\".\"uid\" as \"uid\",\n        \"R\".\"lid\" as \"lid\",\n        \"R\".\"totalTime\" as \"totalTime\",\n        \"R\".\"downCount\" as \"downCount\",\n        \"totalCount\".\"total\" as \"total\"\n      from \n      (SELECT\n              max(\"profile\".\"name\")  as \"user\",\n              max(\"profile\".\"objectId\")  as \"uid\",\n              max(\"lesson\".\"objectId\") as \"lid\",\n              sum(\"record\".\"time\") as \"totalTime\",\n              sum(case when \"record\".\"status\" = 2  then 1 else 0 end) as \"downCount\"\n            from \"LessonRecord\" as \"record\"\n            left join \"Profile\" as \"profile\" on \"profile\".\"objectId\" = \"record\".\"user\"\n            left join \"Department\" as \"Department\" on \"Department\".\"objectId\" = \"record\".\"department\"\n            left join \"SchoolMajor\" as \"schoolMajor\" on \"schoolMajor\".\"objectId\" = \"profile\".\"SchoolMajor\"\n            left join \"SchoolClass\" as \"schoolClass\" on \"schoolClass\".\"objectId\" = \"profile\".\"schoolClass\"\n            left join \"Lesson\" as \"lesson\" on \"lesson\".\"objectId\" = \"record\".\"lesson\"\n          where \"record\".\"company\" = 'pPZbxElQQo'\n            group by \"record\".\"user\", \"record\".\"lesson\") as \"R\"\n      left join \n      (select\n          count(1) as \"total\",\n          max(\"LessonArticle\".\"objectId\") as \"laid\",\n        max(\"LessonArticle\".\"lesson\") as \"lid\"\n        from \"LessonArticle\"\n        left join \"Lesson\" as \"lesson\" on \"lesson\".\"objectId\" = \"LessonArticle\".\"lesson\"\n        where \"LessonArticle\".\"parent\" is not null and \"LessonArticle\".\"company\" = 'pPZbxElQQo'\n        group by \"LessonArticle\".\"lesson\") as \"totalCount\" on \"totalCount\".\"lid\" = \"R\".\"lid\"\n            ) as \"LRInfo\" on \"LRInfo\".\"uid\" = \"PInfo\".\"uid\" and \"LRInfo\".\"lid\" = \"PInfo\".\"lid\"";
            }
            if (this.major && this.school && this.lesson && !this.student) {
                sql = "select\n      \"PInfo\".\"uid\" as \"uid\",\n      \"PInfo\".\"mid\" as \"mid\",\n      \"PInfo\".\"lid\" as \"lid\",\n      \"PInfo\".\"user\" as \"user\",\n      \"PInfo\".\"school\" as \"school\",\n      \"PInfo\".\"major\" as \"major\",\n      \"PInfo\".\"class\" as \"class\",\n      \"PInfo\".\"title\" as \"title\",\n      \"LRInfo\".\"totalTime\" as \"totalTime\",\n      \"LRInfo\".\"downCount\" as \"downCount\",\n      \"LRInfo\".\"total\" as \"total\"\n    from \n      (select \n        \"PR\".\"pid\" as \"uid\",\n        \"PR\".\"mid\" as \"mid\",\n        \"PR\".\"name\" as \"user\",\n        \"PR\".\"school\" as \"school\",\n        \"PR\".\"major\" as \"major\",\n        \"PR\".\"class\" as \"class\",\n        \"M\".\"title\" as \"title\",\n        \"M\".\"objectId\" as \"lid\"\n      from\n        (select\n          \"profile\".\"objectId\" as \"pid\",\n          \"profile\".\"name\" as \"name\",\n          \"department\".\"name\" as \"school\",\n          \"schoolMajor\".\"name\" as \"major\",\n          \"schoolMajor\".\"objectId\" as \"mid\",\n          \"schoolMajor\".\"plan\" as \"plan\",\n          \"schoolClass\".\"name\" as \"class\"\n        from \"Profile\" as \"profile\"\n        left join \"Department\" as \"department\" on \"department\".\"objectId\" = \"profile\".\"department\" \n        left join \"SchoolMajor\" as \"schoolMajor\" on \"schoolMajor\".\"objectId\" = \"profile\".\"SchoolMajor\"\n        left join \"SchoolClass\" as \"schoolClass\" on \"schoolClass\".\"objectId\" = \"profile\".\"schoolClass\"\n        where \"profile\".\"company\" = 'pPZbxElQQo' and \"profile\".\"department\" = '" + this.school + "'\n        and \"profile\".\"SchoolMajor\" = '" + this.major.id + "') as \"PR\"\n    left join\n    (select \n      max(\"majors\".\"majorid\") as \"majorid\",\n      max(\"majors\".\"planid\") as \"planid\",\n      max(\"majors\".\"name\") as \"name\",\n      max(\"lessons\".\"objectId\") as \"objectId\",\n      max(\"lessons\".\"title\") as \"title\",\n      max(\"lessons\".\"teacher\") as \"teacher\"\n    from\n    (select \n      \"schoolMajor\".\"objectId\" as \"majorid\",\n        \"schoolMajor\".\"plan\" as \"planid\",\n      \"schoolMajor\".\"name\" as \"name\"\n    from \"SchoolMajor\" as \"schoolMajor\" where \"schoolMajor\".\"company\" = 'pPZbxElQQo') as \"majors\"\n    left join (\n      select \n        \"lessonObjectId\".\"planid\" as \"planid\",\n        \"lessonObjectId\".\"objectId\" as \"objectId\" ,\n          \"lesson\".\"title\" as \"title\" ,\n        \"teacher\".\"name\" as \"teacher\" \n      from\n          (select \n              \"lessons\".\"lesson\"::json->>'objectId' as \"objectId\",\n          \"lessons\".\"planid\" as \"planid\"\n          from (\n          select \n                jsonb_array_elements(\"plan\".\"lessons\") as \"lesson\",\n            \"plan\".\"objectId\" as \"planid\"\n                from \"SchoolPlan\" as \"plan\"\n          left  join \"SchoolMajor\" as \"major\" on \"major\".\"plan\" = \"plan\".\"objectId\" ) as \"lessons\") as \"lessonObjectId\"\n      left join \"Lesson\" as \"lesson\" on \"lessonObjectId\".\"objectId\" =  \"lesson\".\"objectId\"\n      left join \"LessonTeacher\" as \"teacher\" on  \"lesson\".\"schoolTeacher\" = \"teacher\".\"objectId\"\n    ) as \"lessons\" on \"lessons\".\"planid\" = \"majors\".\"planid\"\n    group by \"majorid\", \"objectId\"\n    order by \"majorid\") as \"M\" on  \"PR\".\"mid\" = \"M\".\"majorid\"\n    where \"M\".\"objectId\" = '" + this.lesson + "'\n    ) as \"PInfo\"\n    left join (\n      SELECT \n      \"R\".\"user\" as \"user\",\n      \"R\".\"uid\" as \"uid\",\n      \"R\".\"lid\" as \"lid\",\n      \"R\".\"totalTime\" as \"totalTime\",\n      \"R\".\"downCount\" as \"downCount\",\n      \"totalCount\".\"total\" as \"total\"\n    from \n    (SELECT\n            max(\"profile\".\"name\")  as \"user\",\n            max(\"profile\".\"objectId\")  as \"uid\",\n            max(\"lesson\".\"objectId\") as \"lid\",\n            sum(\"record\".\"time\") as \"totalTime\",\n            sum(case when \"record\".\"status\" = 2  then 1 else 0 end) as \"downCount\"\n          from \"LessonRecord\" as \"record\"\n          left join \"Profile\" as \"profile\" on \"profile\".\"objectId\" = \"record\".\"user\"\n          left join \"Department\" as \"Department\" on \"Department\".\"objectId\" = \"record\".\"department\"\n          left join \"SchoolMajor\" as \"schoolMajor\" on \"schoolMajor\".\"objectId\" = \"profile\".\"SchoolMajor\"\n          left join \"SchoolClass\" as \"schoolClass\" on \"schoolClass\".\"objectId\" = \"profile\".\"schoolClass\"\n          left join \"Lesson\" as \"lesson\" on \"lesson\".\"objectId\" = \"record\".\"lesson\"\n        where \"record\".\"company\" = 'pPZbxElQQo'\n          group by \"record\".\"user\", \"record\".\"lesson\") as \"R\"\n    left join \n    (select\n        count(1) as \"total\",\n        max(\"LessonArticle\".\"objectId\") as \"laid\",\n      max(\"LessonArticle\".\"lesson\") as \"lid\"\n      from \"LessonArticle\"\n      left join \"Lesson\" as \"lesson\" on \"lesson\".\"objectId\" = \"LessonArticle\".\"lesson\"\n      where \"LessonArticle\".\"parent\" is not null and \"LessonArticle\".\"company\" = 'pPZbxElQQo'\n      group by \"LessonArticle\".\"lesson\") as \"totalCount\" on \"totalCount\".\"lid\" = \"R\".\"lid\"\n          ) as \"LRInfo\" on \"LRInfo\".\"uid\" = \"PInfo\".\"uid\" and \"LRInfo\".\"lid\" = \"PInfo\".\"lid\"";
            }
            if (this.school && this.major && this.lesson && this.student) {
                sql = "select\n      \"PInfo\".\"uid\" as \"uid\",\n      \"PInfo\".\"mid\" as \"mid\",\n      \"PInfo\".\"lid\" as \"lid\",\n      \"PInfo\".\"user\" as \"user\",\n      \"PInfo\".\"school\" as \"school\",\n      \"PInfo\".\"major\" as \"major\",\n      \"PInfo\".\"class\" as \"class\",\n      \"PInfo\".\"title\" as \"title\",\n      \"LRInfo\".\"totalTime\" as \"totalTime\",\n      \"LRInfo\".\"downCount\" as \"downCount\",\n      \"LRInfo\".\"total\" as \"total\"\n    from \n      (select \n        \"PR\".\"pid\" as \"uid\",\n        \"PR\".\"mid\" as \"mid\",\n        \"PR\".\"name\" as \"user\",\n        \"PR\".\"school\" as \"school\",\n        \"PR\".\"major\" as \"major\",\n        \"PR\".\"class\" as \"class\",\n        \"M\".\"title\" as \"title\",\n        \"M\".\"objectId\" as \"lid\"\n      from\n        (select\n          \"profile\".\"objectId\" as \"pid\",\n          \"profile\".\"name\" as \"name\",\n          \"department\".\"name\" as \"school\",\n          \"schoolMajor\".\"name\" as \"major\",\n          \"schoolMajor\".\"objectId\" as \"mid\",\n          \"schoolMajor\".\"plan\" as \"plan\",\n          \"schoolClass\".\"name\" as \"class\"\n        from \"Profile\" as \"profile\"\n        left join \"Department\" as \"department\" on \"department\".\"objectId\" = \"profile\".\"department\" \n        left join \"SchoolMajor\" as \"schoolMajor\" on \"schoolMajor\".\"objectId\" = \"profile\".\"SchoolMajor\"\n        left join \"SchoolClass\" as \"schoolClass\" on \"schoolClass\".\"objectId\" = \"profile\".\"schoolClass\"\n        where \"profile\".\"name\" = '" + this.student + "' and \"profile\".\"company\" = 'pPZbxElQQo' and \"profile\".\"department\" = '" + this.school + "'\n        and \"profile\".\"SchoolMajor\" = '" + this.major.id + "') as \"PR\"\n    left join\n    (select \n      max(\"majors\".\"majorid\") as \"majorid\",\n      max(\"majors\".\"planid\") as \"planid\",\n      max(\"majors\".\"name\") as \"name\",\n      max(\"lessons\".\"objectId\") as \"objectId\",\n      max(\"lessons\".\"title\") as \"title\",\n      max(\"lessons\".\"teacher\") as \"teacher\"\n    from\n    (select \n      \"schoolMajor\".\"objectId\" as \"majorid\",\n        \"schoolMajor\".\"plan\" as \"planid\",\n      \"schoolMajor\".\"name\" as \"name\"\n    from \"SchoolMajor\" as \"schoolMajor\" where \"schoolMajor\".\"company\" = 'pPZbxElQQo') as \"majors\"\n    left join (\n      select \n        \"lessonObjectId\".\"planid\" as \"planid\",\n        \"lessonObjectId\".\"objectId\" as \"objectId\" ,\n          \"lesson\".\"title\" as \"title\" ,\n        \"teacher\".\"name\" as \"teacher\" \n      from\n          (select \n              \"lessons\".\"lesson\"::json->>'objectId' as \"objectId\",\n          \"lessons\".\"planid\" as \"planid\"\n          from (\n          select \n                jsonb_array_elements(\"plan\".\"lessons\") as \"lesson\",\n            \"plan\".\"objectId\" as \"planid\"\n                from \"SchoolPlan\" as \"plan\"\n          left  join \"SchoolMajor\" as \"major\" on \"major\".\"plan\" = \"plan\".\"objectId\" ) as \"lessons\") as \"lessonObjectId\"\n      left join \"Lesson\" as \"lesson\" on \"lessonObjectId\".\"objectId\" =  \"lesson\".\"objectId\"\n      left join \"LessonTeacher\" as \"teacher\" on  \"lesson\".\"schoolTeacher\" = \"teacher\".\"objectId\"\n    ) as \"lessons\" on \"lessons\".\"planid\" = \"majors\".\"planid\"\n    group by \"majorid\", \"objectId\"\n    order by \"majorid\") as \"M\" on  \"PR\".\"mid\" = \"M\".\"majorid\"\n    where \"M\".\"objectId\" = '" + this.lesson + "'\n    ) as \"PInfo\"\n    left join (\n      SELECT \n      \"R\".\"user\" as \"user\",\n      \"R\".\"uid\" as \"uid\",\n      \"R\".\"lid\" as \"lid\",\n      \"R\".\"totalTime\" as \"totalTime\",\n      \"R\".\"downCount\" as \"downCount\",\n      \"totalCount\".\"total\" as \"total\"\n    from \n    (SELECT\n            max(\"profile\".\"name\")  as \"user\",\n            max(\"profile\".\"objectId\")  as \"uid\",\n            max(\"lesson\".\"objectId\") as \"lid\",\n            sum(\"record\".\"time\") as \"totalTime\",\n            sum(case when \"record\".\"status\" = 2  then 1 else 0 end) as \"downCount\"\n          from \"LessonRecord\" as \"record\"\n          left join \"Profile\" as \"profile\" on \"profile\".\"objectId\" = \"record\".\"user\"\n          left join \"Department\" as \"Department\" on \"Department\".\"objectId\" = \"record\".\"department\"\n          left join \"SchoolMajor\" as \"schoolMajor\" on \"schoolMajor\".\"objectId\" = \"profile\".\"SchoolMajor\"\n          left join \"SchoolClass\" as \"schoolClass\" on \"schoolClass\".\"objectId\" = \"profile\".\"schoolClass\"\n          left join \"Lesson\" as \"lesson\" on \"lesson\".\"objectId\" = \"record\".\"lesson\"\n        where \"record\".\"company\" = 'pPZbxElQQo'\n          group by \"record\".\"user\", \"record\".\"lesson\") as \"R\"\n    left join \n    (select\n        count(1) as \"total\",\n        max(\"LessonArticle\".\"objectId\") as \"laid\",\n      max(\"LessonArticle\".\"lesson\") as \"lid\"\n      from \"LessonArticle\"\n      left join \"Lesson\" as \"lesson\" on \"lesson\".\"objectId\" = \"LessonArticle\".\"lesson\"\n      where \"LessonArticle\".\"parent\" is not null and \"LessonArticle\".\"company\" = 'pPZbxElQQo'\n      group by \"LessonArticle\".\"lesson\") as \"totalCount\" on \"totalCount\".\"lid\" = \"R\".\"lid\"\n          ) as \"LRInfo\" on \"LRInfo\".\"uid\" = \"PInfo\".\"uid\" and \"LRInfo\".\"lid\" = \"PInfo\".\"lid\"";
            }
        }
        this.searchAll(sql);
    };
    RecordDashboardComponent.prototype.showTime = function (time) {
        if (time) {
            return (time / 60).toFixed(2) + '分钟';
        }
        else {
            return "暂无";
        }
    };
    RecordDashboardComponent.prototype.showStatus = function (data) {
        if (data.totalTime > 0 && (Number(data.downCount) < Number(data.total))) {
            return "学习中";
        }
        if (data.totalTime == 0 || data.totalTime == null) {
            return "未学习";
        }
        if ((data.total == data.downCount) && data.downCount > 0) {
            return "已学完";
        }
    };
    RecordDashboardComponent.prototype.showSchedule = function (data) {
        if (data.downCount == 0 || data.downCount == null) {
            return "暂无";
        }
        else {
            return ((Number(data.downCount) / Number(data.total)) * 100).toFixed(2) + "%";
        }
    };
    RecordDashboardComponent.prototype.toDetail = function (uid, lid) {
        this.router.navigate(['/masterol-doctor/record-detail', { uid: uid, lid: lid }]);
    };
    RecordDashboardComponent.prototype.showStatusColor = function (data) {
        if (data.totalTime > 0 && (Number(data.downCount) < Number(data.total))) {
            return '#fce603';
        }
        if (data.totalTime == 0 || data.totalTime == null) {
            return "red";
        }
        if ((data.total == data.downCount) && data.downCount > 0) {
            return "#88f5da";
        }
    };
    RecordDashboardComponent = __decorate([
        core_1.Component({
            selector: 'app-record-dashboard',
            templateUrl: './record-dashboard.component.html',
            styleUrls: ['./record-dashboard.component.scss']
        })
    ], RecordDashboardComponent);
    return RecordDashboardComponent;
}());
exports.RecordDashboardComponent = RecordDashboardComponent;
